<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Janne Mäyrä">
<meta name="dcterms.date" content="2022-12-22">

<title>Automated deadwood detection from UAV RGB imagery - Dataset description and generation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./2_comparing_annotations_and_field_data.html" rel="next">
<link href="./0_index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Automated deadwood detection from UAV RGB imagery - Dataset description and generation">
<meta property="og:site-name" content="Automated deadwood detection from UAV RGB imagery">
<meta name="twitter:title" content="Automated deadwood detection from UAV RGB imagery - Dataset description and generation">
<meta name="twitter:creator" content="@mayrajeo">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Automated deadwood detection from UAV RGB imagery</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jaeeolma/maskrcnn-deadwood/"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Dataset description and generation</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./0_index.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Workflow</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1_dataset_description_and_generation.html" class="sidebar-item-text sidebar-link active">Dataset description and generation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2_comparing_annotations_and_field_data.html" class="sidebar-item-text sidebar-link">Comparison of plot characteristics and digitized deadwood</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3_mask_rcnn_model_training.html" class="sidebar-item-text sidebar-link">Mask R-CNN model training</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4_patch_level_results.html" class="sidebar-item-text sidebar-link">Patch level results</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5_scene_level_results.html" class="sidebar-item-text sidebar-link">Scene level results</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./6_result_comparison_with_field_data.html" class="sidebar-item-text sidebar-link">Result comparison with field data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./7_deriving_standwise_metrics_for_evo.html" class="sidebar-item-text sidebar-link">Deriving deadwood statistics for full Evo study area</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./8_configs.html" class="sidebar-item-text sidebar-link">Running models with your own data</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#materials-and-methods" id="toc-materials-and-methods" class="nav-link active" data-scroll-target="#materials-and-methods"><span class="toc-section-number">1</span>  Materials and methods</a>
  <ul class="collapse">
  <li><a href="#study-areas" id="toc-study-areas" class="nav-link" data-scroll-target="#study-areas"><span class="toc-section-number">1.1</span>  Study areas</a></li>
  <li><a href="#virtual-deadwood-data" id="toc-virtual-deadwood-data" class="nav-link" data-scroll-target="#virtual-deadwood-data"><span class="toc-section-number">1.2</span>  Virtual deadwood data</a>
  <ul class="collapse">
  <li><a href="#hiidenportti-dataset" id="toc-hiidenportti-dataset" class="nav-link" data-scroll-target="#hiidenportti-dataset"><span class="toc-section-number">1.2.1</span>  Hiidenportti dataset</a></li>
  <li><a href="#evo-dataset" id="toc-evo-dataset" class="nav-link" data-scroll-target="#evo-dataset"><span class="toc-section-number">1.2.2</span>  Evo dataset</a></li>
  <li><a href="#training-data-generation" id="toc-training-data-generation" class="nav-link" data-scroll-target="#training-data-generation"><span class="toc-section-number">1.2.3</span>  Training data generation</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/jaeeolma/maskrcnn-deadwood/blob/main/notebooks/1_dataset_description_and_generation.ipynb" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Dataset description and generation</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Janne Mäyrä </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 22, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, sys</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">'whitegrid'</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> drone_detector.utils <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> drone_detector.processing.tiling <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="st">'..'</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.tree_functions <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>tqdm.pandas()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualization functions</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> LineString, box, Point, Polygon</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry.polygon <span class="im">import</span> orient</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.ops <span class="im">import</span> nearest_points</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_three_point_diam_lines(geom):</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> get_len(geom)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    mrr <span class="op">=</span> geom.minimum_rotated_rectangle</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    mrr <span class="op">=</span> orient(mrr)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    mrr_x, mrr_y <span class="op">=</span> mrr.exterior.coords.xy</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    a_ix <span class="op">=</span> <span class="bu">list</span>(mrr_y).index(<span class="bu">min</span>(mrr_y))</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    b_ix <span class="op">=</span> a_ix <span class="op">+</span> <span class="dv">1</span> <span class="cf">if</span> a_ix <span class="op">&lt;</span> <span class="dv">3</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    c_ix <span class="op">=</span> b_ix <span class="op">+</span> <span class="dv">1</span> <span class="cf">if</span> b_ix <span class="op">&lt;</span> <span class="dv">3</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    d_ix <span class="op">=</span> c_ix <span class="op">+</span> <span class="dv">1</span> <span class="cf">if</span> c_ix <span class="op">&lt;</span> <span class="dv">3</span> <span class="cf">else</span> <span class="dv">0</span> </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    ab <span class="op">=</span> LineString([Point(mrr_x[a_ix], mrr_y[a_ix]), Point(mrr_x[b_ix], mrr_y[b_ix])])</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    ad <span class="op">=</span> LineString([Point(mrr_x[a_ix], mrr_y[a_ix]), Point(mrr_x[d_ix], mrr_y[d_ix])])</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ab.length <span class="op">&gt;</span> ad.length:</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        maxline <span class="op">=</span> ab</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        max_ort <span class="op">=</span> LineString([Point(mrr_x[d_ix], mrr_y[d_ix]), Point(mrr_x[c_ix], mrr_y[c_ix])])</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        maxline <span class="op">=</span> ad</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        max_ort <span class="op">=</span> LineString([Point(mrr_x[b_ix], mrr_y[b_ix]), Point(mrr_x[c_ix], mrr_y[c_ix])]) </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    bot_a, bot_b <span class="op">=</span> maxline.boundary</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    top_a, top_b <span class="op">=</span> max_ort.boundary</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> top_a.y <span class="op">==</span> top_b.y: <span class="co"># horizontal</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        line_10 <span class="op">=</span> LineString([Point(<span class="bu">min</span>(top_a.x, top_b.x) <span class="op">+</span> <span class="fl">0.10</span><span class="op">*</span>d, top_a.y), </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>                              Point(<span class="bu">min</span>(bot_a.x, bot_b.x) <span class="op">+</span> <span class="fl">0.10</span><span class="op">*</span>d, bot_a.y)])</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        line_50 <span class="op">=</span> LineString([Point(<span class="bu">min</span>(top_a.x, top_b.x) <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span>d, top_a.y), </span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>                              Point(<span class="bu">min</span>(bot_a.x, bot_b.x) <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span>d, bot_a.y)])</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        line_90 <span class="op">=</span> LineString([Point(<span class="bu">max</span>(top_a.x, top_b.x) <span class="op">-</span> <span class="fl">0.10</span><span class="op">*</span>d, top_b.y),</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>                              Point(<span class="bu">max</span>(bot_a.x, bot_b.x) <span class="op">-</span> <span class="fl">0.10</span><span class="op">*</span>d, bot_b.y)])</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> top_a.x <span class="op">==</span> top_b.x: <span class="co"># vertical</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        line_10 <span class="op">=</span> LineString([Point(top_a.x, <span class="bu">min</span>(top_a.y,  top_b.y) <span class="op">+</span> <span class="fl">0.10</span><span class="op">*</span>d), </span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>                              Point(bot_a.x, <span class="bu">min</span>(bot_a.y,  bot_b.y) <span class="op">+</span> <span class="fl">0.10</span><span class="op">*</span>d)])</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        line_50 <span class="op">=</span> LineString([Point(top_a.x, <span class="bu">min</span>(top_a.y,  top_b.y) <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span>d), </span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>                              Point(bot_a.x, <span class="bu">min</span>(bot_a.y,  bot_b.y) <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span>d)])</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        line_90 <span class="op">=</span> LineString([Point(top_b.x, <span class="bu">max</span>(top_a.y,  top_b.y) <span class="op">-</span> <span class="fl">0.10</span><span class="op">*</span>d), </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>                              Point(bot_b.x, <span class="bu">max</span>(bot_a.y,  bot_b.y) <span class="op">-</span> <span class="fl">0.10</span><span class="op">*</span>d)])</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># we do geometry, solve &lt;x,y&gt; = &lt;x_1,y_1&gt; + t&lt;1,m&gt;</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> (bot_b.y <span class="op">-</span> bot_a.y) <span class="op">/</span> (bot_b.x <span class="op">-</span> bot_a.x)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        mul <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> k <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        top_x_10 <span class="op">=</span> top_a.x <span class="op">+</span> mul <span class="op">*</span> np.sqrt(((<span class="fl">0.10</span><span class="op">*</span>d)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>k<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        top_x_50 <span class="op">=</span> top_a.x <span class="op">+</span> mul <span class="op">*</span> np.sqrt(((<span class="fl">0.5</span><span class="op">*</span>d)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>k<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        top_x_90 <span class="op">=</span> top_a.x <span class="op">+</span> mul <span class="op">*</span> np.sqrt(((<span class="fl">0.90</span><span class="op">*</span>d)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>k<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        top_y_10 <span class="op">=</span> top_a.y <span class="op">+</span> np.sqrt(((<span class="fl">0.10</span><span class="op">*</span>d<span class="op">*</span>k)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>k<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        top_y_50 <span class="op">=</span> top_a.y <span class="op">+</span> np.sqrt(((<span class="fl">0.5</span><span class="op">*</span>d<span class="op">*</span>k)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>k<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>        top_y_90 <span class="op">=</span> top_a.y <span class="op">+</span> np.sqrt(((<span class="fl">0.90</span><span class="op">*</span>d<span class="op">*</span>k)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>k<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        bot_x_10 <span class="op">=</span> bot_a.x <span class="op">+</span> mul <span class="op">*</span> np.sqrt(((<span class="fl">0.10</span><span class="op">*</span>d)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>k<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        bot_x_50 <span class="op">=</span> bot_a.x <span class="op">+</span> mul <span class="op">*</span> np.sqrt(((<span class="fl">0.5</span><span class="op">*</span>d)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>k<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        bot_x_90 <span class="op">=</span> bot_a.x <span class="op">+</span> mul <span class="op">*</span> np.sqrt(((<span class="fl">0.90</span><span class="op">*</span>d)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>k<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        bot_y_10 <span class="op">=</span> bot_a.y <span class="op">+</span> np.sqrt(((<span class="fl">0.10</span><span class="op">*</span>d<span class="op">*</span>k)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>k<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        bot_y_50 <span class="op">=</span> bot_a.y <span class="op">+</span> np.sqrt(((<span class="fl">0.5</span><span class="op">*</span>d<span class="op">*</span>k)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>k<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>        bot_y_90 <span class="op">=</span> bot_a.y <span class="op">+</span> np.sqrt(((<span class="fl">0.90</span><span class="op">*</span>d<span class="op">*</span>k)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span>k<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>        line_10 <span class="op">=</span> LineString([Point(top_x_10, top_y_10), Point(bot_x_10, bot_y_10)])</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>        line_50 <span class="op">=</span> LineString([Point(top_x_50, top_y_50), Point(bot_x_50, bot_y_50)])</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        line_90 <span class="op">=</span> LineString([Point(top_x_90, top_y_90), Point(bot_x_90, bot_y_90)])</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> line_10, line_50, line_90</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_iline(geom):</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    p1, p2 <span class="op">=</span> nearest_points(geom.minimum_rotated_rectangle.exterior, geom.representative_point())</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    minx, miny, maxx, maxy <span class="op">=</span> geom.bounds</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    line <span class="op">=</span> LineString([p1,p2])</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    bbox <span class="op">=</span> box(<span class="op">*</span>geom.bounds)</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    a,b <span class="op">=</span> line.boundary</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> a.x <span class="op">==</span> b.x:</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>        extended_line <span class="op">=</span> LineString([(a.x, miny), (a.x, maxy)])</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> a.y <span class="op">==</span> b.y:</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>        extended_line <span class="op">=</span> LineString([(minx, a.y), (maxx, a.y)])</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> (b.y <span class="op">-</span> a.y) <span class="op">/</span> (b.x <span class="op">-</span> a.x)</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> a.y <span class="op">-</span> k <span class="op">*</span> a.x</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>        y0 <span class="op">=</span> k <span class="op">*</span> minx <span class="op">+</span> m</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>        y1 <span class="op">=</span> k <span class="op">*</span> maxx <span class="op">+</span> m</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>        x0 <span class="op">=</span> (miny <span class="op">-</span> m) <span class="op">/</span> k</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>        x1 <span class="op">=</span> (maxy <span class="op">-</span> m) <span class="op">/</span> k</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>        points_on_boundary_lines <span class="op">=</span> [Point(minx, y0), Point(maxx, y1), </span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>                                    Point(x0, miny), Point(x1, maxy)]</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>        points_sorted_by_distance <span class="op">=</span> <span class="bu">sorted</span>(points_on_boundary_lines, key<span class="op">=</span>bbox.distance)</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>        extended_line <span class="op">=</span> LineString(points_sorted_by_distance[:<span class="dv">2</span>])</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> extended_line.intersection(geom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="materials-and-methods" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Materials and methods</h1>
<section id="study-areas" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="study-areas"><span class="header-section-number">1.1</span> Study areas</h2>
<p>The first study area is located in the eastern side of Hiidenportti National Park, Sotkamo, Eastern-Finland, and the field data contains areas both inside and outside the conserved areas (Hiidenportti National Park in the west and Teerisuo - Lososuo area in the east). The most common trees in Hiidenportti area are Scots pine and Norway spruce, with different deciduous trees (e.g.&nbsp;Silver birch, Downy birch and European aspen). The UAV data from this study area consist of nine partially overlapping RGB orthoimages which cover approximately 10 km² area, with spatial resolution ranging between 3.9cm and 4.4cm. These scenes cover both conserved and managed forests, as well as some logging openings. The UAV data were collected on 16. and 17.7.2019 using DJI Phantom 4 RTK UAV equipped with 20 megapixel CMOS sensor.</p>
<p>Our other study area is located in Sudenpesänkangas, Evo, Southern-Finland. The data was acquired on 11.7.2018, using eBee Plus RTK fixed-wing platform, equipped with a 20 megapixel global shutter S.O.D.A camera with a field of view of 64<span class="math inline">\(^{\circ}\)</span>. The UAV data from Evo consist of a single RGB orthomosaic which has a spatial resolution of 4.9cm. The area covers both managed and conserved areas, and the canopy is mostly dominated by Scots pine and Norway spruce, with a mixture of the two birch species. Other species (e.g.&nbsp;aspen and larch) are rather scarce in dominant canopy layer. Data from Evo was used for testing the methods in different geographical location</p>
<p>In addition to UAV data, we also have high-resolution LiDAR data from both of our study areas. The point density for Hiidenportti LiDAR data was approximately 15 points/m<span class="math inline">\(^2\)</span>, and 11 points/m<span class="math inline">\(^2\)</span> for Evo LiDAR data. These LiDAR data from Hiidenportti were the same as used in <a href="https://www.sciencedirect.com/science/article/pii/S0378112721003133">Heinaro et al (2021)</a>, while the LiDAR data from Evo were used in both <a href="https://www.mdpi.com/2072-4292/12/16/2610">Viinikka et al (2020</a> and <a href="https://www.sciencedirect.com/science/article/pii/S0034425721000407">Mäyrä et al (2021)</a>. We used these data to create canopy height models (CHMs) with 0.5m spatial resoution for both study areas, which were then used to compute the canopy densities for the field plots.</p>
</section>
<section id="virtual-deadwood-data" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="virtual-deadwood-data"><span class="header-section-number">1.2</span> Virtual deadwood data</h2>
<p>Having accurate and good quality ground reference data is not only important for training the models, but also for evaluating the obtained results. Even though we had extensive field data from both of our study areas, using only these data would not provide enough training data for our methods. For both of our study areas, we constructed rectangular virtual plots (<em>scenes</em>) in such way that all usable field plots were covered. Because the sizes of the UAV mosaics were different between the study areas, these plots were constructed slightly differently. For Hiidenportti dataset, we constructed 33 rectangular scenes in such way that all usable field plots were covered and each plot had at least 45 meter distance to the border of the scene. As the total area of Sudenpesänkangas UAV-mosaic is larger than Hiidenportti, we constructed the scenes for Evo area as 100x100 meter non-overlapping squares in such way that each virtual plot contained only one circular field plot.</p>
<p>We manually annotated all visible deadwood from the scenes to use our reference data. Both deadwood types were annotated as a separate classes. The standing deadwood instances were annotated so that the full canopy were inside the polygon, but for fallen deadwood we annotated the trunks and left the branches and twigs unannotated. We annotated even the shortest deadwood instances visible, as it was possible that in reality they belonged of a larger trunk, but were partially obscured by canopy.</p>
<section id="hiidenportti-dataset" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="hiidenportti-dataset"><span class="header-section-number">1.2.1</span> Hiidenportti dataset</h3>
<p>Out of the 178 circular field plots with 9m radius present in the Hiidenportti area, our UAV data covered 75 in such way that the image quality was sufficient for our study. Out of these 75, we omitted four plots as they had been cut down between the time of field work and UAV flights, bringing the total number of field plots to 71. 23 of these field plots contained accurately measured and located deadwood data, collected by <a href="https://www.sciencedirect.com/science/article/pii/S0378112721003133">Heinaro et al (2021)</a>. In Evo area, the UAV data covered 79 circular field plots with 9 meter radius, from which 71 had suitable image quality for our use cases.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>full_data <span class="op">=</span> gpd.read_file(<span class="st">'../../data/raw/hiidenportti/virtual_plots/all_deadwood_hiidenportti.geojson'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>conservation_areas <span class="op">=</span> gpd.read_file(<span class="st">'../data/common/LsAlueValtio.shp'</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>cons_hp <span class="op">=</span> conservation_areas[conservation_areas.geometry.intersects(box(<span class="op">*</span>full_data.total_bounds))]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>full_data[<span class="st">'conservation'</span>] <span class="op">=</span> full_data.progress_apply(<span class="kw">lambda</span> row: <span class="dv">1</span> <span class="cf">if</span> row.geometry.intersects(cons_hp.geometry.unary_union)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="cf">else</span> <span class="dv">0</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>full_data.to_file(<span class="st">'../../data/raw/hiidenportti/virtual_plots/all_deadwood_hiidenportti.geojson'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ac10073c61dc400f9ab21bcbd4332567","version_major":2,"version_minor":0}
</script>
</div>
</div>
<p>In total, the final deadwood data contained 7396 annotated fallen deadwood and 1083 standing deadwood instances. The total numbers of deadwood instances present in a single virtual plot varied between 47 and 1051, the number of fallen deadwood between 31 and 990, and for the number of standing deadwood between 1 and 159. Relatively, standing deadwood was much more common in conserved areas than in managed forests, as 59% (639 instances) of standing deadwood were located in conservation areas, compared to 30.6% (2260 instances) of fallen deadwood.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(full_data.conservation, full_data.layer, margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>layer</th>
      <th>groundwood</th>
      <th>uprightwood</th>
      <th>All</th>
    </tr>
    <tr>
      <th>conservation</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5909</td>
      <td>683</td>
      <td>6592</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1487</td>
      <td>400</td>
      <td>1887</td>
    </tr>
    <tr>
      <th>All</th>
      <td>7396</td>
      <td>1083</td>
      <td>8479</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>In addition to the total number of deadwood instances, these data tells us also the total area covered in m² as well as pixels for each deadwood type, both for the polygons and their bounding boxes. Based on the annotated polygons, we estimated the trunk length of the fallen deadwood and the maximum canopy diameter of the standing deadwood to be the longer side of the minimum rotated rectangle for the corresponding polygon. Because the spatial resolution of our data is around 4cm, we did not estimate fallen deadwood diameter or volume, as even an error of one pixel effects these calculations too much.</p>
<p>Overall, the total area covered by fallen deadwood was 3459.81m² and 3565.37m² by standing deadwood. The mean area covered by a single fallen deadwood polygon was around 0.47m² and 3.29m² for standing deadwood.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>full_data[<span class="st">'area'</span>] <span class="op">=</span> full_data.geometry.area</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>full_data[<span class="st">'pixel_area'</span>] <span class="op">=</span> full_data.area <span class="op">/</span> <span class="fl">0.04</span><span class="op">**</span><span class="dv">2</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>full_data_dis <span class="op">=</span> full_data.dissolve(by<span class="op">=</span><span class="st">'layer'</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>full_data_dis.area</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>layer
groundwood     3459.805448
uprightwood    3565.369704
dtype: float64</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>pd.pivot_table(full_data, index<span class="op">=</span>[<span class="st">'layer'</span>], values<span class="op">=</span><span class="st">'area'</span>, aggfunc<span class="op">=</span>[<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>, <span class="st">'median'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>median</th>
    </tr>
    <tr>
      <th></th>
      <th>area</th>
      <th>area</th>
      <th>area</th>
      <th>area</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>0.024711</td>
      <td>5.789380</td>
      <td>0.469012</td>
      <td>0.348866</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>0.103820</td>
      <td>24.334151</td>
      <td>3.292461</td>
      <td>2.416391</td>
    </tr>
    <tr>
      <th>All</th>
      <td>0.024711</td>
      <td>24.334151</td>
      <td>0.829644</td>
      <td>0.395097</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-display">
<pre><code>&lt;seaborn.axisgrid.FacetGrid&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="1_dataset_description_and_generation_files/figure-html/cell-9-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Based on the annotated polygons, we also estimated the trunk length of the fallen deadwood and the maximum canopy diameter of the standing deadwood to be the longest side of the minimum rotated rectangle for the corresponding polygon. For diameter and volume estimation for the fallen deadwood, we constructed three lines that are perpendicular with the minimum rotated rectangle of the polygon that intersect in the polygon at the 10%, 50% and 90% of the length. This process is visualized below. Based on these lines, we used the mean length of these intersecting lines to estimate the polygon diameter. For the volume estimation, we assumed that the fallen deadwood polygons are constructed from two truncated right circular cones and used the following equations to estimate the volume:</p>
<p><span class="math display">\[
    V_{1} = \frac{\pi h(r_{10}^2 + r_{10}r_{50} + r_{50}^2)}{3} \\
    V_{2} = \frac{\pi h(r_{90}^2 + r_{90}r_{50} + r_{50}^2)}{3} \\
    V = V_1 + V_2
\]</span></p>
<p>where r<span class="math inline">\(_{x}\)</span> are the radii at the length percentile of x, and h is half the estimated polygon length.</p>
<div class="cell">
<div class="cell-output cell-output-display">
<p><img src="1_dataset_description_and_generation_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The average fallen deadwood trunk length was around 2.48 meters, with the shortest annotated tree being 0.21m and longest 15.38m. On average, both deadwood types were larger in the conservation areas compared to the managed forests. It is worth mentioning that 1655 of the annotated fallen deadwood were shorter than 1.3m (the minimum length for the tree to be measured in the Finnish National Forest Inventory), but due to the possibility of them being partially obscured by the canopy, they were included in the deadwood data.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>full_data[<span class="st">'tree_length'</span>] <span class="op">=</span> full_data.<span class="bu">apply</span>(<span class="kw">lambda</span> row: get_len(row.geometry), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(full_data[(full_data.layer <span class="op">==</span> <span class="st">'groundwood'</span>) <span class="op">&amp;</span> (full_data.tree_length <span class="op">&lt;</span> <span class="fl">1.3</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>1655</code></pre>
</div>
</div>
<p>Statistics for estimated tree length and canopy diameter.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>pd.pivot_table(full_data, index<span class="op">=</span>[<span class="st">'layer'</span>], </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>               values<span class="op">=</span>[<span class="st">'tree_length'</span>], aggfunc<span class="op">=</span>[<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>, <span class="st">'median'</span>, <span class="st">'count'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>median</th>
      <th>count</th>
    </tr>
    <tr>
      <th></th>
      <th>tree_length</th>
      <th>tree_length</th>
      <th>tree_length</th>
      <th>tree_length</th>
      <th>tree_length</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>0.206041</td>
      <td>15.383351</td>
      <td>2.404708</td>
      <td>2.002028</td>
      <td>7396</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>0.385542</td>
      <td>8.313442</td>
      <td>2.323786</td>
      <td>2.154042</td>
      <td>1083</td>
    </tr>
    <tr>
      <th>All</th>
      <td>0.206041</td>
      <td>15.383351</td>
      <td>2.394372</td>
      <td>2.024371</td>
      <td>8479</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>pd.pivot_table(full_data, index<span class="op">=</span>[<span class="st">'conservation'</span>, <span class="st">'layer'</span>], </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>               values<span class="op">=</span>[<span class="st">'tree_length'</span>], aggfunc<span class="op">=</span>[<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>, <span class="st">'median'</span>, <span class="st">'count'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>median</th>
      <th>count</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>tree_length</th>
      <th>tree_length</th>
      <th>tree_length</th>
      <th>tree_length</th>
      <th>tree_length</th>
    </tr>
    <tr>
      <th>conservation</th>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">0</th>
      <th>groundwood</th>
      <td>0.206041</td>
      <td>15.383351</td>
      <td>2.284923</td>
      <td>1.915742</td>
      <td>5909</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>0.385542</td>
      <td>6.977358</td>
      <td>2.248640</td>
      <td>2.075352</td>
      <td>683</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">1</th>
      <th>groundwood</th>
      <td>0.346741</td>
      <td>12.954119</td>
      <td>2.880703</td>
      <td>2.388131</td>
      <td>1487</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>0.633733</td>
      <td>8.313442</td>
      <td>2.452099</td>
      <td>2.294426</td>
      <td>400</td>
    </tr>
    <tr>
      <th>All</th>
      <th></th>
      <td>0.206041</td>
      <td>15.383351</td>
      <td>2.394372</td>
      <td>2.024371</td>
      <td>8479</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-display">
<p><img src="1_dataset_description_and_generation_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Statistics for estimated diameter for groundwood.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>full_data[<span class="st">'diam'</span>] <span class="op">=</span> full_data.geometry.<span class="bu">apply</span>(<span class="kw">lambda</span> row: np.mean(get_three_point_diams(row))) <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>pd.pivot_table(full_data[full_data.layer<span class="op">==</span><span class="st">'groundwood'</span>], index<span class="op">=</span>[<span class="st">'conservation'</span>], </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>               values<span class="op">=</span>[<span class="st">'diam'</span>], aggfunc<span class="op">=</span>[<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>, <span class="st">'median'</span>, <span class="st">'count'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>median</th>
      <th>count</th>
    </tr>
    <tr>
      <th></th>
      <th>diam</th>
      <th>diam</th>
      <th>diam</th>
      <th>diam</th>
      <th>diam</th>
    </tr>
    <tr>
      <th>conservation</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>55.336382</td>
      <td>626.065954</td>
      <td>180.397765</td>
      <td>172.583156</td>
      <td>5909</td>
    </tr>
    <tr>
      <th>1</th>
      <td>68.693180</td>
      <td>677.660650</td>
      <td>208.541880</td>
      <td>190.436852</td>
      <td>1487</td>
    </tr>
    <tr>
      <th>All</th>
      <td>55.336382</td>
      <td>677.660650</td>
      <td>186.056270</td>
      <td>175.094096</td>
      <td>7396</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-display">
<p><img src="1_dataset_description_and_generation_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Look at the largest polygons.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># echo: false</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">4</span>))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ix, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axs.flatten()):</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    full_data[(full_data.layer <span class="op">==</span> <span class="st">'groundwood'</span>)<span class="op">&amp;</span>(full_data.diam<span class="op">&gt;</span><span class="dv">650</span>)].iloc[ix:ix<span class="op">+</span><span class="dv">1</span>].exterior.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">"#e41a1c"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    temp <span class="op">=</span> full_data[(full_data.layer <span class="op">==</span> <span class="st">'groundwood'</span>)<span class="op">&amp;</span>(full_data.diam<span class="op">&gt;</span><span class="dv">650</span>)].iloc[ix:ix<span class="op">+</span><span class="dv">1</span>].copy()</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    geom <span class="op">=</span> temp.iloc[<span class="dv">0</span>].geometry</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    temp[<span class="st">'geometry'</span>] <span class="op">=</span> temp.<span class="bu">apply</span>(<span class="kw">lambda</span> row: row.geometry.minimum_rotated_rectangle, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    temp.exterior.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'#377eb8'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    temp[<span class="st">'geometry'</span>] <span class="op">=</span> temp.<span class="bu">apply</span>(<span class="kw">lambda</span> row: LineString([(row.geometry.exterior.xy[<span class="dv">0</span>][<span class="dv">0</span>], row.geometry.exterior.xy[<span class="dv">1</span>][<span class="dv">0</span>]),</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>                                                         (row.geometry.exterior.xy[<span class="dv">0</span>][<span class="dv">1</span>], row.geometry.exterior.xy[<span class="dv">1</span>][<span class="dv">1</span>])]),</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>                                  axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    temp.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'#377eb8'</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    temp2 <span class="op">=</span> full_data[(full_data.layer <span class="op">==</span> <span class="st">'groundwood'</span>)<span class="op">&amp;</span>(full_data.diam<span class="op">&gt;</span><span class="dv">650</span>)].iloc[ix:ix<span class="op">+</span><span class="dv">1</span>].copy()</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> get_three_point_diam_lines(temp2.iloc[<span class="dv">0</span>].geometry)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> l <span class="kw">in</span> lines:</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        temp2[<span class="st">'geometry'</span>] <span class="op">=</span> l</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>        temp2.plot(ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">'#4daf4a'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> l <span class="kw">in</span> lines:</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        temp2[<span class="st">'geometry'</span>] <span class="op">=</span> l.intersection(geom)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        temp2.plot(ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">'#984ea3'</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="1_dataset_description_and_generation_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Estimations for volume of fallen deadwood.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>full_data[<span class="st">'v'</span>] <span class="op">=</span> full_data.geometry.<span class="bu">apply</span>(cut_cone_volume)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>pd.pivot_table(full_data[full_data.layer<span class="op">==</span><span class="st">'groundwood'</span>], index<span class="op">=</span>[<span class="st">'conservation'</span>], </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>               values<span class="op">=</span>[<span class="st">'v'</span>], aggfunc<span class="op">=</span>[<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>, <span class="st">'median'</span>, <span class="st">'count'</span>, <span class="st">'sum'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>median</th>
      <th>count</th>
      <th>sum</th>
    </tr>
    <tr>
      <th></th>
      <th>v</th>
      <th>v</th>
      <th>v</th>
      <th>v</th>
      <th>v</th>
      <th>v</th>
    </tr>
    <tr>
      <th>conservation</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.001237</td>
      <td>2.399251</td>
      <td>0.072439</td>
      <td>0.046403</td>
      <td>5909</td>
      <td>428.041718</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.002850</td>
      <td>2.130253</td>
      <td>0.128083</td>
      <td>0.070668</td>
      <td>1487</td>
      <td>190.459568</td>
    </tr>
    <tr>
      <th>All</th>
      <td>0.001237</td>
      <td>2.399251</td>
      <td>0.083626</td>
      <td>0.050058</td>
      <td>7396</td>
      <td>618.501287</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-display">
<p><img src="1_dataset_description_and_generation_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Finally, get estimations of total volume of groundwood m³/ha.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>field_data_path <span class="op">=</span> Path(<span class="st">'../data/hiidenportti'</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>virtual_plot_grid <span class="op">=</span> gpd.read_file(field_data_path<span class="op">/</span><span class="st">'envelopes_with_trees.geojson'</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>tot_vplot_area <span class="op">=</span> virtual_plot_grid.area.<span class="bu">sum</span>()</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>cons_areas <span class="op">=</span> gpd.clip(cons_hp, virtual_plot_grid)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>tot_cons_area <span class="op">=</span> cons_areas.area.<span class="bu">sum</span>()</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>tot_man_area <span class="op">=</span> tot_vplot_area <span class="op">-</span> tot_cons_area</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>tot_man_ha <span class="op">=</span> tot_man_area <span class="op">/</span> <span class="dv">10000</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>tot_cons_ha <span class="op">=</span> tot_cons_area <span class="op">/</span> <span class="dv">10000</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>est_v_man <span class="op">=</span> full_data[(full_data.layer<span class="op">==</span><span class="st">'groundwood'</span>)<span class="op">&amp;</span>(full_data.conservation<span class="op">==</span><span class="dv">0</span>)].v.<span class="bu">sum</span>()<span class="op">/</span>tot_man_ha</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>est_v_cons <span class="op">=</span> full_data[(full_data.layer<span class="op">==</span><span class="st">'groundwood'</span>)<span class="op">&amp;</span>(full_data.conservation<span class="op">==</span><span class="dv">1</span>)].v.<span class="bu">sum</span>()<span class="op">/</span>tot_cons_ha</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>est_v_tot <span class="op">=</span> full_data[(full_data.layer<span class="op">==</span><span class="st">'groundwood'</span>)].v.<span class="bu">sum</span>()<span class="op">/</span>(tot_vplot_area<span class="op">/</span><span class="dv">10000</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Estimated groundwood volume in managed forests: </span><span class="sc">{</span>est_v_man<span class="sc">:.2f}</span><span class="ss"> ha/m³'</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Estimated groundwood volume in conserved forests: </span><span class="sc">{</span>est_v_cons<span class="sc">:.2f}</span><span class="ss"> ha/m³'</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Estimated groundwood volume in both types: </span><span class="sc">{</span>est_v_tot<span class="sc">:.2f}</span><span class="ss"> ha/m³'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Estimated groundwood volume in managed forests: 10.76 ha/m³
Estimated groundwood volume in conserved forests: 11.59 ha/m³
Estimated groundwood volume in both types: 11.00 ha/m³</code></pre>
</div>
</div>
</section>
<section id="evo-dataset" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="evo-dataset"><span class="header-section-number">1.2.2</span> Evo dataset</h3>
<p>We constructed the scenes from Evo area as 100x100 meter non-overlapping squares in such way that each virtual plot contained only one circular field plot. This dataset contained 3915 fallen deadwood and 1419 standing deadwood instances, and the total number of deadwood instances in a single field plot varied between 3 and 570, the number of fallen deadwood between 1 and 570, and the number of standing deadwood between 1 and 162.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>evo_data <span class="op">=</span> gpd.read_file(<span class="st">'../../data/raw/sudenpesankangas/virtual_plots/sudenpesankangas_deadwood.geojson'</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>cons_evo <span class="op">=</span> conservation_areas[conservation_areas.geometry.intersects(box(<span class="op">*</span>evo_data.total_bounds))]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>evo_data[<span class="st">'conservation'</span>] <span class="op">=</span> evo_data.progress_apply(<span class="kw">lambda</span> row: <span class="dv">1</span> <span class="cf">if</span> row.geometry.intersects(cons_evo.geometry.unary_union)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                                                               <span class="cf">else</span> <span class="dv">0</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>evo_data.to_file(<span class="st">'../../data/raw/sudenpesankangas/virtual_plots/sudenpesankangas_deadwood.geojson'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9159b9dc53374065941c7cf5c917a824","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(evo_data.conservation, evo_data.label, margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>label</th>
      <th>groundwood</th>
      <th>uprightwood</th>
      <th>All</th>
    </tr>
    <tr>
      <th>conservation</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2369</td>
      <td>386</td>
      <td>2755</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1546</td>
      <td>1033</td>
      <td>2579</td>
    </tr>
    <tr>
      <th>All</th>
      <td>3915</td>
      <td>1419</td>
      <td>5334</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>The total area covered by fallen deadwood was 3117.1m² and the total canopy area for standing deadwood was 7196.4m². On average, a single deadwood instance covered more area compared to Hiidenportti dataset, as the average area for fallen deadwood in Evo was 0.81m² and 5.08m² for standing deadwood.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>evo_data[<span class="st">'area'</span>] <span class="op">=</span> evo_data.geometry.area</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>evo_data[<span class="st">'pixel_area'</span>] <span class="op">=</span> evo_data.area <span class="op">/</span> <span class="fl">0.0485</span><span class="op">**</span><span class="dv">2</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>evo_data_dis <span class="op">=</span> evo_data.dissolve(by<span class="op">=</span><span class="st">'label'</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>evo_data_dis.area</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>label
groundwood     3117.087445
uprightwood    7196.352919
dtype: float64</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>pd.pivot_table(evo_data, index<span class="op">=</span>[<span class="st">'conservation'</span>, <span class="st">'label'</span>], values<span class="op">=</span><span class="st">'area'</span>, </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>               aggfunc<span class="op">=</span>[<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>, <span class="st">'median'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>median</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>area</th>
      <th>area</th>
      <th>area</th>
      <th>area</th>
    </tr>
    <tr>
      <th>conservation</th>
      <th>label</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">0</th>
      <th>groundwood</th>
      <td>0.064145</td>
      <td>8.456464</td>
      <td>0.646843</td>
      <td>0.489316</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>0.364184</td>
      <td>41.339628</td>
      <td>3.142462</td>
      <td>2.017817</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">1</th>
      <th>groundwood</th>
      <td>0.092866</td>
      <td>8.173691</td>
      <td>1.049027</td>
      <td>0.735591</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>0.319265</td>
      <td>35.944833</td>
      <td>5.811285</td>
      <td>4.102591</td>
    </tr>
    <tr>
      <th>All</th>
      <th></th>
      <td>0.064145</td>
      <td>41.339628</td>
      <td>1.944172</td>
      <td>0.758211</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-display">
<pre><code>&lt;seaborn.axisgrid.FacetGrid&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="1_dataset_description_and_generation_files/figure-html/cell-25-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Similar observations were found from the average tree length and canopy diameter, as the average trunk length of the fallen trees was around 1 meter more in Evo, and canopy diameter of standing trees was around 60cm larger. However, this is likely due to the vast majority of the annotated trees in Evo dataset being in conserved areas.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>evo_data[<span class="st">'tree_length'</span>] <span class="op">=</span> evo_data.<span class="bu">apply</span>(<span class="kw">lambda</span> row: get_len(row.geometry), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>pd.pivot_table(evo_data, index<span class="op">=</span>[<span class="st">'label'</span>], </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>               values<span class="op">=</span>[<span class="st">'tree_length'</span>], aggfunc<span class="op">=</span>[<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>, <span class="st">'median'</span>, <span class="st">'count'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>median</th>
      <th>count</th>
    </tr>
    <tr>
      <th></th>
      <th>tree_length</th>
      <th>tree_length</th>
      <th>tree_length</th>
      <th>tree_length</th>
      <th>tree_length</th>
    </tr>
    <tr>
      <th>label</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>0.575351</td>
      <td>24.479043</td>
      <td>3.429642</td>
      <td>2.790052</td>
      <td>3915</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>0.674329</td>
      <td>8.319080</td>
      <td>2.958530</td>
      <td>2.745163</td>
      <td>1419</td>
    </tr>
    <tr>
      <th>All</th>
      <td>0.575351</td>
      <td>24.479043</td>
      <td>3.304312</td>
      <td>2.779696</td>
      <td>5334</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>pd.pivot_table(evo_data, index<span class="op">=</span>[<span class="st">'conservation'</span>,<span class="st">'label'</span>], </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>               values<span class="op">=</span>[<span class="st">'tree_length'</span>], aggfunc<span class="op">=</span>[<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>, <span class="st">'median'</span>, <span class="st">'count'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>median</th>
      <th>count</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>tree_length</th>
      <th>tree_length</th>
      <th>tree_length</th>
      <th>tree_length</th>
      <th>tree_length</th>
    </tr>
    <tr>
      <th>conservation</th>
      <th>label</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">0</th>
      <th>groundwood</th>
      <td>0.605847</td>
      <td>24.479043</td>
      <td>3.113435</td>
      <td>2.609120</td>
      <td>2369</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>0.674329</td>
      <td>8.319080</td>
      <td>2.310101</td>
      <td>2.080163</td>
      <td>386</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">1</th>
      <th>groundwood</th>
      <td>0.575351</td>
      <td>22.625422</td>
      <td>3.914179</td>
      <td>3.145306</td>
      <td>1546</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>0.779996</td>
      <td>7.974969</td>
      <td>3.200828</td>
      <td>2.981814</td>
      <td>1033</td>
    </tr>
    <tr>
      <th>All</th>
      <th></th>
      <td>0.575351</td>
      <td>24.479043</td>
      <td>3.304312</td>
      <td>2.779696</td>
      <td>5334</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-display">
<p><img src="1_dataset_description_and_generation_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>In addition of annotated fallen trees being longer in Evo than Hiidenportti, they were also thicker, as the average diameter around 20mm more in both forest types, and only 7 annotations had diameter less than 100mm.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>evo_data[<span class="st">'diam'</span>] <span class="op">=</span> evo_data.geometry.<span class="bu">apply</span>(<span class="kw">lambda</span> row: np.mean(get_three_point_diams(row))) <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>pd.pivot_table(evo_data[evo_data.label<span class="op">==</span><span class="st">'groundwood'</span>], index<span class="op">=</span>[<span class="st">'conservation'</span>], </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>               values<span class="op">=</span>[<span class="st">'diam'</span>], aggfunc<span class="op">=</span>[<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>, <span class="st">'median'</span>, <span class="st">'count'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>median</th>
      <th>count</th>
    </tr>
    <tr>
      <th></th>
      <th>diam</th>
      <th>diam</th>
      <th>diam</th>
      <th>diam</th>
      <th>diam</th>
    </tr>
    <tr>
      <th>conservation</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>85.977991</td>
      <td>760.781151</td>
      <td>200.474161</td>
      <td>188.603269</td>
      <td>2369</td>
    </tr>
    <tr>
      <th>1</th>
      <td>101.096058</td>
      <td>709.170305</td>
      <td>254.250350</td>
      <td>233.417789</td>
      <td>1546</td>
    </tr>
    <tr>
      <th>All</th>
      <td>85.977991</td>
      <td>760.781151</td>
      <td>221.709917</td>
      <td>203.275219</td>
      <td>3915</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-display">
<p><img src="1_dataset_description_and_generation_files/figure-html/cell-30-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Look at the largest polygons.</p>
<div class="cell">
<div class="cell-output cell-output-display">
<p><img src="1_dataset_description_and_generation_files/figure-html/cell-31-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>evo_data[<span class="st">'v'</span>] <span class="op">=</span> evo_data.geometry.<span class="bu">apply</span>(cut_cone_volume)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>pd.pivot_table(evo_data[evo_data.label<span class="op">==</span><span class="st">'groundwood'</span>], index<span class="op">=</span>[<span class="st">'conservation'</span>], </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>               values<span class="op">=</span>[<span class="st">'v'</span>], aggfunc<span class="op">=</span>[<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>, <span class="st">'median'</span>, <span class="st">'count'</span>, <span class="st">'sum'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>median</th>
      <th>count</th>
      <th>sum</th>
    </tr>
    <tr>
      <th></th>
      <th>v</th>
      <th>v</th>
      <th>v</th>
      <th>v</th>
      <th>v</th>
      <th>v</th>
    </tr>
    <tr>
      <th>conservation</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.004749</td>
      <td>2.765285</td>
      <td>0.125592</td>
      <td>0.076470</td>
      <td>2369</td>
      <td>297.527245</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.011879</td>
      <td>4.192773</td>
      <td>0.262005</td>
      <td>0.141118</td>
      <td>1546</td>
      <td>405.059473</td>
    </tr>
    <tr>
      <th>All</th>
      <td>0.004749</td>
      <td>4.192773</td>
      <td>0.179460</td>
      <td>0.092882</td>
      <td>3915</td>
      <td>702.586718</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-display">
<p><img src="1_dataset_description_and_generation_files/figure-html/cell-33-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The estimated total volume of fallen deadwood was 702.59 m<sup>3</sup>, of which 297.52m<sup>3</sup> was in managed forests and 405.06m<sup>3</sup> in conservation areas, corresponding to 7.08m<sup>3</sup>/ha of deadwood in managed forests and 13.97 m<sup>3</sup>/ha in conserved forests.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>evo_fd_path <span class="op">=</span> Path(<span class="st">'../data/sudenpesankangas/'</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>evo_grid <span class="op">=</span> gpd.read_file(evo_fd_path<span class="op">/</span><span class="st">'vplots.geojson'</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>evo_grid <span class="op">=</span> evo_grid.to_crs(<span class="st">'epsg:3067'</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>evo_tot_vplot_area <span class="op">=</span> evo_grid.area.<span class="bu">sum</span>()</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>evo_cons_area <span class="op">=</span> cons_evo.overlay(evo_grid).area.<span class="bu">sum</span>()</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>evo_man_area <span class="op">=</span> evo_tot_vplot_area <span class="op">-</span> evo_cons_area</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>evo_man_ha <span class="op">=</span> evo_man_area <span class="op">/</span> <span class="dv">10000</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>evo_cons_ha <span class="op">=</span> evo_cons_area <span class="op">/</span> <span class="dv">10000</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>evo_tot_ha <span class="op">=</span> evo_man_ha <span class="op">+</span> evo_cons_ha</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>evo_est_v_man <span class="op">=</span> evo_data[(evo_data.label<span class="op">==</span><span class="st">'groundwood'</span>)<span class="op">&amp;</span>(evo_data.conservation<span class="op">==</span><span class="dv">0</span>)].v.<span class="bu">sum</span>()<span class="op">/</span>evo_man_ha</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>evo_est_v_cons <span class="op">=</span> evo_data[(evo_data.label<span class="op">==</span><span class="st">'groundwood'</span>)<span class="op">&amp;</span>(evo_data.conservation<span class="op">==</span><span class="dv">1</span>)].v.<span class="bu">sum</span>()<span class="op">/</span>evo_cons_ha</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>evo_est_v_tot <span class="op">=</span> evo_data[(evo_data.label<span class="op">==</span><span class="st">'groundwood'</span>)].v.<span class="bu">sum</span>()<span class="op">/</span>evo_tot_ha</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Estimated groundwood volume in managed forests: </span><span class="sc">{</span>evo_est_v_man<span class="sc">:.2f}</span><span class="ss"> ha/m³'</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Estimated groundwood volume in conserved forests: </span><span class="sc">{</span>evo_est_v_cons<span class="sc">:.2f}</span><span class="ss"> ha/m³'</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Estimated groundwood volume in both types: </span><span class="sc">{</span>evo_est_v_tot<span class="sc">:.2f}</span><span class="ss"> ha/m³'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Estimated groundwood volume in managed forests: 7.08 ha/m³
Estimated groundwood volume in conserved forests: 13.97 ha/m³
Estimated groundwood volume in both types: 9.90 ha/m³</code></pre>
</div>
</div>
</section>
<section id="training-data-generation" class="level3" data-number="1.2.3">
<h3 data-number="1.2.3" class="anchored" data-anchor-id="training-data-generation"><span class="header-section-number">1.2.3</span> Training data generation</h3>
<p>In order to ensure that no training data leaked into the test set, which would have given our models overly optimistic results, we selected 5 of the virtual plots as the holdout set to test our models. These virtual plots contained both managed and conserved areas, and were only used for testing the models. Furthermore, the remaining 28 plots were spatially split to training and validation sets with 85:15 ratio to ensure that the models were validated during training with data not used for training.</p>
<p>As our virtual plots had too large dimensions to be efficiently used as the training data for the deep learning models, the final preprocessing step for UAV plot images was to split each of them into 512 times 512 pixel image patches. We also split the the polygon data into separate files so that each file only covers this smaller area. Finally, we converted the polygon data into COCO format, in which the polygon coordinates are converted into pixel coordinates related to the corresponding image. Because mosaicking images this way meant that some of the annotated polygons were only partially present in image patches, we removed all partial annotations whose area was less than 25% of the original annotation. Also, all polygons that had bounding box smaller than 16 pixels were discarded, as that small targets can not be accurately found from the data. For test images, as the model outputs were in COCO format, the results were transformed into georeferenced polygon data.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>tile_folder <span class="op">=</span> Path(<span class="st">'../../data/raw/hiidenportti/virtual_plots/train/images/'</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>vector_folder <span class="op">=</span> Path(<span class="st">'../../data/raw/hiidenportti/virtual_plots/train/vectors/'</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>outpath <span class="op">=</span> Path(<span class="st">'../../data/processed/hiidenportti/train_512'</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>tiles <span class="op">=</span> os.listdir(tile_folder)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>vectors <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(vector_folder) <span class="cf">if</span> f.endswith(<span class="st">'geojson'</span>)]</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(tiles) <span class="op">==</span> <span class="bu">len</span>(vectors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> tiles:</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>]): os.makedirs(outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>])</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    shp_fname <span class="op">=</span> t.replace(<span class="st">'tif'</span>, <span class="st">'geojson'</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    tilesize <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    tiler <span class="op">=</span> Tiler(outpath<span class="op">=</span>outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>], gridsize_x<span class="op">=</span>tilesize, gridsize_y<span class="op">=</span>tilesize, overlap<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    tiler.tile_raster(<span class="bu">str</span>(tile_folder<span class="op">/</span>t))</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    tiler.tile_vector(vector_folder<span class="op">/</span>shp_fname, min_area_pct<span class="op">=</span><span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b8675bf7cae64171af4cc6f571a2f906","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bdbe7d005ded4e0891ceceb5dbd7ed8c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d55e9a7660e74a99994a7da5a9d1bf8f","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ff435de95bb9456487f9931785cb02e5","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0c4d2d415a6145d99c07fcc536297d5f","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d8ed62b1782a4f05aa7720071d0c9b1c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"abdbeaeff2aa4f9584c25bc062065c4e","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"cf8549d33f9a4933ac124edfd0b3d96a","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"289a8e07a09d440aa0f380a1625c63c1","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bfc6111a4afb412eac73c431ab1df51c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"945df4809f5647e4a2d3f873da8cfca5","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"48ed80e9c67c4ef0acf6dfdafc176271","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"277ba426f630481dbbcf2c458f31604b","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ddd295368df8449facaef68709435cd6","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3b58bad6de74410992a0c8c35363d6f6","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2cf29da1b339430b99f33229222ae059","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c1389926a8ac4bb7aa8298b8320bdb95","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d3ca13fc8969483e80740f9a19b0d7ca","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"af912c05c574437eb75f10189a587aa7","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7cbafd619a614851ad55771ec9f4604a","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"abd2adcea704499586d461327e72238a","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1a99d788fba6434f89c07de3b6e0cd44","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c2d08f0d9ae34eac9cfd0293e122cfe1","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0a2f41acf47c48e4b49b5946d3882460","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6bbffe0433ac446896d9972edc38d5d1","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bda6fd5bffc7471cb9b17b37eee2ab96","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b0c3f8066b3c4cf39b54a2b52503f5d4","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e7e112b7d4d549548def72e1cd2756ff","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"79fddad82bd54e55b4d2cbb33fb23e07","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"753f1d61ba6e4cdea7262bc204e60316","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c4af315f09f94d8cbf603d32e43d68a7","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"64eed034638f4f8f96feaf99b4dd13a2","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5cb20dff168f4f91992e1f1c38276d2e","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"49bd15cbcf874159a8356e542557cb5d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"aea596b965864ba7878b2612357f2dff","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"52c1d15c6fd746ffb3f863645ff37dfa","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"645484c019224f8a84cd690eba4de79c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3a26c0eed8ba4f4a840a5c25e13b26a6","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6952c85346014ce2b5dab5023a740b88","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"54e5e9242da944f191de4b66328d8f54","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b1367d6c46d84c16a15b70aa579450d0","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"aa351b02cfff438993b5aedd47aa5fe7","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"403f28c978dd478783b1def3d5e9929d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c3646f5cf3ef459db451f28ed0074d58","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1615e7cdfe204fe6aab72a221bcae948","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b896c3a1910a4bcd83700c828aca3fd0","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shapely</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> box</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Fix labelling, todo fix it in COCOProcessor</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> [outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'vector_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'vector_tiles'</span>) <span class="cf">if</span> f.endswith(<span class="st">'geojson'</span>)]</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> files: </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.read_file(f)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> box(<span class="op">*</span>gdf.total_bounds)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf.geometry.<span class="bu">buffer</span>(<span class="dv">0</span>) <span class="co"># fix faulty geometries</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf.<span class="bu">apply</span>(<span class="kw">lambda</span> row: fix_multipolys(row.geometry) <span class="cf">if</span> row.geometry.<span class="bu">type</span> <span class="op">==</span> <span class="st">'MultiPolygon'</span> </span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">else</span> shapely.geometry.Polygon(row.geometry.exterior), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        gdf.rename(columns<span class="op">=</span>{<span class="st">'groundwood'</span>:<span class="st">'label'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.clip(gdf, bbox, keep_geom_type<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'label'</span>] <span class="op">=</span> gdf.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="st">'Standing'</span> <span class="cf">if</span> row.label <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">'Fallen'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        gdf.to_file(f, driver<span class="op">=</span><span class="st">'GeoJSON'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to COCO format</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> drone_detector.processing.coco <span class="im">import</span> <span class="op">*</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>deadwood_categories <span class="op">=</span> [</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'supercategory'</span>:<span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">1</span>, <span class="st">'name'</span>: <span class="st">'uprightwood'</span>},</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'supercategory'</span>:<span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">2</span>, <span class="st">'name'</span>: <span class="st">'groundwood'</span>},</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>coco_info <span class="op">=</span> {<span class="st">'description'</span>: <span class="st">'Train dataset for deadwood detection in Hiidenportti'</span>,</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">'version'</span>: <span class="fl">0.1</span>,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">'year'</span>: <span class="dv">2022</span>,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">'contributor'</span>: <span class="st">'Janne Mäyrä'</span>,</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>             <span class="st">'date_created'</span>: date.today().strftime(<span class="st">"%Y/%m/</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>coco_licenses <span class="op">=</span> {}</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    coco_processor <span class="op">=</span> COCOProcessor(outpath<span class="op">/</span>p, outpath<span class="op">/</span>p, coco_info<span class="op">=</span>coco_info, coco_licenses<span class="op">=</span>coco_licenses,</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>                                  coco_categories<span class="op">=</span>deadwood_categories)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>    coco_processor.shp_to_coco(<span class="st">'layer'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8462a57a10d4466f8884758794ac26cc","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4eebea8a56944d67a76e502767f77890","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f252f9f550174d6b90b7ed2184f9a651","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bff2191cf9504f6e9e85e4fb080bf964","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2dd770617dd047e18e67f878eda25209","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1dd2ee56b4cc49f484b32f90fa0da734","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8d571dafc48846e8959010c9a8eef08c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ecf5817012874477a37bb241db2d5cf3","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3bed20cd12054db881a21e370ff41f3f","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5aa5d28b079d4d5180374c952ea999d8","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5a96b96ee0124805b023e07497f6b58f","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"dd3bbf1825574104ae3959f4abf60956","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"48186c3f35bf47bc918a401a05bf7151","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"44744ff503584fbda35ea729889a0cfa","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d0c49d11b02d49c9aaec7a2d743a6b2f","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"337d62784899409b96a901be0c224a79","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"26808858e0c9449387ae8588f2fbd9b9","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"98de19439c5748e1b7951fafe42a52f0","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"83a9455b90574b24adfd8ced6b26b519","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8e8c723460194a33ba0697510f6b406c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5ebb339bebcb4485823081b74982f828","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6e2ee11fedee45159f909ddbed0bf64f","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f5d285c653964e22bbe3c8fa38f4682f","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine several coco-annotation .json files into one</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>full_coco <span class="op">=</span> <span class="va">None</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>image_id_modifier <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>ann_id_modifier <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'coco.json'</span>) <span class="im">as</span> f:</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>        coco <span class="op">=</span> json.load(f)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># update filename</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> coco[<span class="st">'images'</span>]:</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>        i[<span class="st">'file_name'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss">/raster_tiles/</span><span class="sc">{</span>i[<span class="st">'file_name'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> full_coco <span class="kw">is</span> <span class="va">None</span>: </span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>        full_coco <span class="op">=</span> coco</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>        image_id_modifier <span class="op">=</span> full_coco[<span class="st">'images'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>]</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>        ann_id_modifier <span class="op">=</span> full_coco[<span class="st">'annotations'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>]</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> coco[<span class="st">'images'</span>]:</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>            i[<span class="st">'id'</span>] <span class="op">+=</span> image_id_modifier</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> a <span class="kw">in</span> coco[<span class="st">'annotations'</span>]:</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>            a[<span class="st">'image_id'</span>] <span class="op">+=</span> image_id_modifier</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>            a[<span class="st">'id'</span>] <span class="op">+=</span> ann_id_modifier</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>        full_coco[<span class="st">'images'</span>].extend(coco[<span class="st">'images'</span>])</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>        full_coco[<span class="st">'annotations'</span>].extend(coco[<span class="st">'annotations'</span>])</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>        image_id_modifier <span class="op">=</span> full_coco[<span class="st">'images'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>        ann_id_modifier <span class="op">=</span> full_coco[<span class="st">'annotations'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(outpath.parents[<span class="dv">0</span>]<span class="op">/</span><span class="st">'hiidenportti_train.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> outfile: json.dump(full_coco, outfile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>tile_folder <span class="op">=</span> Path(<span class="st">'../../data/raw/hiidenportti/virtual_plots/valid/images/'</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>vector_folder <span class="op">=</span> Path(<span class="st">'../../data/raw/hiidenportti/virtual_plots/valid/vectors/'</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>outpath <span class="op">=</span> Path(<span class="st">'../../data/processed/hiidenportti/valid_512'</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>tiles <span class="op">=</span> os.listdir(tile_folder)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>vectors <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(vector_folder) <span class="cf">if</span> f.endswith(<span class="st">'geojson'</span>)]</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(tiles) <span class="op">==</span> <span class="bu">len</span>(vectors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> tiles:</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>]): os.makedirs(outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>])</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    shp_fname <span class="op">=</span> t.replace(<span class="st">'tif'</span>, <span class="st">'geojson'</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    tilesize <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    tiler <span class="op">=</span> Tiler(outpath<span class="op">=</span>outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>], gridsize_x<span class="op">=</span>tilesize, gridsize_y<span class="op">=</span>tilesize, overlap<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    tiler.tile_raster(<span class="bu">str</span>(tile_folder<span class="op">/</span>t))</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    tiler.tile_vector(vector_folder<span class="op">/</span>shp_fname, min_area_pct<span class="op">=</span><span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f8c042f324b34ce4aae8e9d1d2d21c25","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0f418b53f617495fa59dec735351fd49","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ba1df00b7f4d47a1a9dd8601f2500ff8","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e1b8b663fd9844ea8df9a92842f3a6e8","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5c86ed4ab6f446228a977a44f6ee9cd1","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"72064c27fae54d6686b3b7620b2d7fbf","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"877b3a00f07a4ecf97c2eaa3f7478d97","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ef69639f8cd64719b7512b61c60359a1","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6a9210c2106944c7b8d2c7e51a3c646b","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0f7ca27365164bb7bd24bdc0a612b96f","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Fix labelling, todo fix it in COCOProcessor</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> [outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'vector_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'vector_tiles'</span>) <span class="cf">if</span> f.endswith(<span class="st">'geojson'</span>)]</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> files: </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.read_file(f)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> box(<span class="op">*</span>gdf.total_bounds)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf.geometry.<span class="bu">buffer</span>(<span class="dv">0</span>) <span class="co"># fix faulty geometries</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf.<span class="bu">apply</span>(<span class="kw">lambda</span> row: fix_multipolys(row.geometry) <span class="cf">if</span> row.geometry.<span class="bu">type</span> <span class="op">==</span> <span class="st">'MultiPolygon'</span> </span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">else</span> shapely.geometry.Polygon(row.geometry.exterior), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>        gdf.rename(columns<span class="op">=</span>{<span class="st">'groundwood'</span>:<span class="st">'label'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.clip(gdf, bbox, keep_geom_type<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'label'</span>] <span class="op">=</span> gdf.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="st">'Standing'</span> <span class="cf">if</span> row.label <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">'Fallen'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        gdf.to_file(f, driver<span class="op">=</span><span class="st">'GeoJSON'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to COCO format</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> drone_detector.processing.coco <span class="im">import</span> <span class="op">*</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>deadwood_categories <span class="op">=</span> [</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'supercategory'</span>:<span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">1</span>, <span class="st">'name'</span>: <span class="st">'uprightwood'</span>},</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'supercategory'</span>:<span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">2</span>, <span class="st">'name'</span>: <span class="st">'groundwood'</span>},</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>coco_info <span class="op">=</span> {<span class="st">'description'</span>: <span class="st">'Validation dataset for deadwood detection in Hiidenportti'</span>,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">'version'</span>: <span class="fl">0.1</span>,</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">'year'</span>: <span class="dv">2022</span>,</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">'contributor'</span>: <span class="st">'Janne Mäyrä'</span>,</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>             <span class="st">'date_created'</span>: date.today().strftime(<span class="st">"%Y/%m/</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>coco_licenses <span class="op">=</span> {}</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    coco_processor <span class="op">=</span> COCOProcessor(outpath<span class="op">/</span>p, outpath<span class="op">/</span>p, coco_info<span class="op">=</span>coco_info, coco_licenses<span class="op">=</span>coco_licenses,</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>                                  coco_categories<span class="op">=</span>deadwood_categories)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    coco_processor.shp_to_coco(<span class="st">'layer'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"412d26a164c848b2aeb071c307ae4431","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"39636051067d43efa224052ccb18eb15","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e6ba32c2fdba43e986b32ac103e7310f","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1b317257426b4474a56218bc3f7f932c","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"95f9fe2ea2b44397a456db6950c4b141","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine several coco-annotation .json files into one</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>full_coco <span class="op">=</span> <span class="va">None</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>image_id_modifier <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>ann_id_modifier <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'coco.json'</span>) <span class="im">as</span> f:</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        coco <span class="op">=</span> json.load(f)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># update filename</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> coco[<span class="st">'images'</span>]:</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>        i[<span class="st">'file_name'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss">/raster_tiles/</span><span class="sc">{</span>i[<span class="st">'file_name'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> full_coco <span class="kw">is</span> <span class="va">None</span>: </span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>        full_coco <span class="op">=</span> coco</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>        image_id_modifier <span class="op">=</span> full_coco[<span class="st">'images'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>]</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>        ann_id_modifier <span class="op">=</span> full_coco[<span class="st">'annotations'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>]</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> coco[<span class="st">'images'</span>]:</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>            i[<span class="st">'id'</span>] <span class="op">+=</span> image_id_modifier</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> a <span class="kw">in</span> coco[<span class="st">'annotations'</span>]:</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>            a[<span class="st">'image_id'</span>] <span class="op">+=</span> image_id_modifier</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>            a[<span class="st">'id'</span>] <span class="op">+=</span> ann_id_modifier</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>        full_coco[<span class="st">'images'</span>].extend(coco[<span class="st">'images'</span>])</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>        full_coco[<span class="st">'annotations'</span>].extend(coco[<span class="st">'annotations'</span>])</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>        image_id_modifier <span class="op">=</span> full_coco[<span class="st">'images'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>        ann_id_modifier <span class="op">=</span> full_coco[<span class="st">'annotations'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(outpath.parents[<span class="dv">0</span>]<span class="op">/</span><span class="st">'hiidenportti_valid.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> outfile: json.dump(full_coco, outfile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>tile_folder <span class="op">=</span> Path(<span class="st">'../../data/raw/hiidenportti/virtual_plots/test/images/'</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>vector_folder <span class="op">=</span> Path(<span class="st">'../../data/raw/hiidenportti/virtual_plots/test/vectors/'</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>outpath <span class="op">=</span> Path(<span class="st">'../../data/processed/hiidenportti/test_512'</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>tiles <span class="op">=</span> os.listdir(tile_folder)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>vectors <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(vector_folder) <span class="cf">if</span> f.endswith(<span class="st">'geojson'</span>)]</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(tiles) <span class="op">==</span> <span class="bu">len</span>(vectors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> tiles:</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>]): os.makedirs(outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>])</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    shp_fname <span class="op">=</span> t.replace(<span class="st">'tif'</span>, <span class="st">'geojson'</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    tilesize <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    tiler <span class="op">=</span> Tiler(outpath<span class="op">=</span>outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>], gridsize_x<span class="op">=</span>tilesize, gridsize_y<span class="op">=</span>tilesize, overlap<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    tiler.tile_raster(<span class="bu">str</span>(tile_folder<span class="op">/</span>t))</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    tiler.tile_vector(vector_folder<span class="op">/</span>shp_fname, min_area_pct<span class="op">=</span><span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e23d4060191c4a59a693da4a6186fecf","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"73fe3ea3493f45ed9de93cccda422369","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7def4fc408e347938d3d4c17e7359bbb","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ac4b5e0e060e4a85a81e0d33ac92b128","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e3883519c5ac4faf84e005d431322a14","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3f76b1756fe549c4821b283a6fcf3ed6","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"cae73f435fdc497f9942900818cd481e","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a456086a0ddc455caf34a39391e9ffc8","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a9e7e823f2f44ee9837bec6db5a89ef9","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b50f337472b34fc7a2b91f59e8c94f7d","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Fix labelling, todo fix it in COCOProcessor</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> [outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'vector_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'vector_tiles'</span>) <span class="cf">if</span> f.endswith(<span class="st">'geojson'</span>)]</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> files: </span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.read_file(f)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> box(<span class="op">*</span>gdf.total_bounds)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf.geometry.<span class="bu">buffer</span>(<span class="dv">0</span>) <span class="co"># fix faulty geometries</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf.<span class="bu">apply</span>(<span class="kw">lambda</span> row: fix_multipolys(row.geometry) <span class="cf">if</span> row.geometry.<span class="bu">type</span> <span class="op">==</span> <span class="st">'MultiPolygon'</span> </span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">else</span> shapely.geometry.Polygon(row.geometry.exterior), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        gdf.rename(columns<span class="op">=</span>{<span class="st">'groundwood'</span>:<span class="st">'label'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.clip(gdf, bbox, keep_geom_type<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'label'</span>] <span class="op">=</span> gdf.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="st">'Standing'</span> <span class="cf">if</span> row.label <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">'Fallen'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>        gdf.to_file(f, driver<span class="op">=</span><span class="st">'GeoJSON'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to COCO format</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> drone_detector.processing.coco <span class="im">import</span> <span class="op">*</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>deadwood_categories <span class="op">=</span> [</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'supercategory'</span>:<span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">1</span>, <span class="st">'name'</span>: <span class="st">'uprightwood'</span>},</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'supercategory'</span>:<span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">2</span>, <span class="st">'name'</span>: <span class="st">'groundwood'</span>},</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>coco_info <span class="op">=</span> {<span class="st">'description'</span>: <span class="st">'Test dataset for deadwood detection in Hiidenportti'</span>,</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">'version'</span>: <span class="fl">0.1</span>,</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">'year'</span>: <span class="dv">2022</span>,</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">'contributor'</span>: <span class="st">'Janne Mäyrä'</span>,</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>             <span class="st">'date_created'</span>: date.today().strftime(<span class="st">"%Y/%m/</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>coco_licenses <span class="op">=</span> {}</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    coco_processor <span class="op">=</span> COCOProcessor(outpath<span class="op">/</span>p, outpath<span class="op">/</span>p, coco_info<span class="op">=</span>coco_info, coco_licenses<span class="op">=</span>coco_licenses,</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>                                  coco_categories<span class="op">=</span>deadwood_categories)</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    coco_processor.shp_to_coco(<span class="st">'layer'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a8a92ecd4d6340e0896cd66027131e17","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7f4c212cd4cc4ef59a98e75a10387d6b","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1ae9492dbf544fdb8c4114d035f3b5a7","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8d55fa1bd8ce4a1f893b446b48bf231b","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"31fa5896e7af41ce82cca21ac6f6670b","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine several coco-annotation .json files into one</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>full_coco <span class="op">=</span> <span class="va">None</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>image_id_modifier <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>ann_id_modifier <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'coco.json'</span>) <span class="im">as</span> f:</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        coco <span class="op">=</span> json.load(f)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># update filename</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> coco[<span class="st">'images'</span>]:</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        i[<span class="st">'file_name'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss">/raster_tiles/</span><span class="sc">{</span>i[<span class="st">'file_name'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> full_coco <span class="kw">is</span> <span class="va">None</span>: </span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>        full_coco <span class="op">=</span> coco</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>        image_id_modifier <span class="op">=</span> full_coco[<span class="st">'images'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>]</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>        ann_id_modifier <span class="op">=</span> full_coco[<span class="st">'annotations'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>]</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> coco[<span class="st">'images'</span>]:</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>            i[<span class="st">'id'</span>] <span class="op">+=</span> image_id_modifier</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> a <span class="kw">in</span> coco[<span class="st">'annotations'</span>]:</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>            a[<span class="st">'image_id'</span>] <span class="op">+=</span> image_id_modifier</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>            a[<span class="st">'id'</span>] <span class="op">+=</span> ann_id_modifier</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>        full_coco[<span class="st">'images'</span>].extend(coco[<span class="st">'images'</span>])</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>        full_coco[<span class="st">'annotations'</span>].extend(coco[<span class="st">'annotations'</span>])</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>        image_id_modifier <span class="op">=</span> full_coco[<span class="st">'images'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>        ann_id_modifier <span class="op">=</span> full_coco[<span class="st">'annotations'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(outpath.parents[<span class="dv">0</span>]<span class="op">/</span><span class="st">'hiidenportti_test.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> outfile: json.dump(full_coco, outfile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>tile_folder <span class="op">=</span> Path(<span class="st">'../../data/raw/sudenpesankangas/virtual_plots/train/images/'</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>vector_folder <span class="op">=</span> Path(<span class="st">'../../data/raw/sudenpesankangas/virtual_plots/train/vectors/'</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>outpath <span class="op">=</span> Path(<span class="st">'../../data/processed/sudenpesankangas/train_512'</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>tiles <span class="op">=</span> os.listdir(tile_folder)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>vectors <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(vector_folder) <span class="cf">if</span> f.endswith(<span class="st">'geojson'</span>)]</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(tiles) <span class="op">==</span> <span class="bu">len</span>(vectors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> tiles:</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>]): os.makedirs(outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>])</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    shp_fname <span class="op">=</span> t.replace(<span class="st">'tif'</span>, <span class="st">'geojson'</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    tilesize <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    tiler <span class="op">=</span> Tiler(outpath<span class="op">=</span>outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>], gridsize_x<span class="op">=</span>tilesize, gridsize_y<span class="op">=</span>tilesize, overlap<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    tiler.tile_raster(<span class="bu">str</span>(tile_folder<span class="op">/</span>t))</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    tiler.tile_vector(vector_folder<span class="op">/</span>shp_fname, min_area_pct<span class="op">=</span><span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Fix labelling, todo fix it in COCOProcessor</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> [outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'vector_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'vector_tiles'</span>) <span class="cf">if</span> f.endswith(<span class="st">'geojson'</span>)]</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> files: </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.read_file(f)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> box(<span class="op">*</span>gdf.total_bounds)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf.geometry.<span class="bu">buffer</span>(<span class="dv">0</span>) <span class="co"># fix faulty geometries</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf.<span class="bu">apply</span>(<span class="kw">lambda</span> row: fix_multipolys(row.geometry) <span class="cf">if</span> row.geometry.<span class="bu">type</span> <span class="op">==</span> <span class="st">'MultiPolygon'</span> </span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">else</span> shapely.geometry.Polygon(row.geometry.exterior), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.clip(gdf, bbox, keep_geom_type<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>        gdf.to_file(f, driver<span class="op">=</span><span class="st">'GeoJSON'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to COCO format</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> drone_detector.processing.coco <span class="im">import</span> <span class="op">*</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>deadwood_categories <span class="op">=</span> [</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'supercategory'</span>:<span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">1</span>, <span class="st">'name'</span>: <span class="st">'uprightwood'</span>},</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'supercategory'</span>:<span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">2</span>, <span class="st">'name'</span>: <span class="st">'groundwood'</span>},</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>coco_info <span class="op">=</span> {<span class="st">'description'</span>: <span class="st">'Train dataset for deadwood detection in Sudenpesänkangas'</span>,</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">'version'</span>: <span class="fl">0.1</span>,</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">'year'</span>: <span class="dv">2022</span>,</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">'contributor'</span>: <span class="st">'Janne Mäyrä'</span>,</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>             <span class="st">'date_created'</span>: date.today().strftime(<span class="st">"%Y/%m/</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>coco_licenses <span class="op">=</span> {}</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>    coco_processor <span class="op">=</span> COCOProcessor(outpath<span class="op">/</span>p, outpath<span class="op">/</span>p, coco_info<span class="op">=</span>coco_info, coco_licenses<span class="op">=</span>coco_licenses,</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>                                  coco_categories<span class="op">=</span>deadwood_categories)</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    coco_processor.shp_to_coco(<span class="st">'label'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine several coco-annotation .json files into one</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>full_coco <span class="op">=</span> <span class="va">None</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>image_id_modifier <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>ann_id_modifier <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'coco.json'</span>) <span class="im">as</span> f:</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>        coco <span class="op">=</span> json.load(f)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># update filename</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> coco[<span class="st">'images'</span>]:</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>        i[<span class="st">'file_name'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss">/raster_tiles/</span><span class="sc">{</span>i[<span class="st">'file_name'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> full_coco <span class="kw">is</span> <span class="va">None</span>: </span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>        full_coco <span class="op">=</span> coco</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>        image_id_modifier <span class="op">=</span> full_coco[<span class="st">'images'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>]</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>        ann_id_modifier <span class="op">=</span> full_coco[<span class="st">'annotations'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>]</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> coco[<span class="st">'images'</span>]:</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>            i[<span class="st">'id'</span>] <span class="op">+=</span> image_id_modifier</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> a <span class="kw">in</span> coco[<span class="st">'annotations'</span>]:</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>            a[<span class="st">'image_id'</span>] <span class="op">+=</span> image_id_modifier</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>            a[<span class="st">'id'</span>] <span class="op">+=</span> ann_id_modifier</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>        full_coco[<span class="st">'images'</span>].extend(coco[<span class="st">'images'</span>])</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>        full_coco[<span class="st">'annotations'</span>].extend(coco[<span class="st">'annotations'</span>])</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>        image_id_modifier <span class="op">=</span> full_coco[<span class="st">'images'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>        ann_id_modifier <span class="op">=</span> full_coco[<span class="st">'annotations'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(outpath.parents[<span class="dv">0</span>]<span class="op">/</span><span class="st">'sudenpesankangas_train.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> outfile: json.dump(full_coco, outfile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>tile_folder <span class="op">=</span> Path(<span class="st">'../../data/raw/sudenpesankangas/virtual_plots/valid/images/'</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>vector_folder <span class="op">=</span> Path(<span class="st">'../../data/raw/sudenpesankangas/virtual_plots/valid/vectors/'</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>outpath <span class="op">=</span> Path(<span class="st">'../../data/processed/sudenpesankangas/valid_512'</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>tiles <span class="op">=</span> os.listdir(tile_folder)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>vectors <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(vector_folder) <span class="cf">if</span> f.endswith(<span class="st">'geojson'</span>)]</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(tiles) <span class="op">==</span> <span class="bu">len</span>(vectors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> tiles:</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>]): os.makedirs(outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>])</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    shp_fname <span class="op">=</span> t.replace(<span class="st">'tif'</span>, <span class="st">'geojson'</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    tilesize <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    tiler <span class="op">=</span> Tiler(outpath<span class="op">=</span>outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>], gridsize_x<span class="op">=</span>tilesize, gridsize_y<span class="op">=</span>tilesize, overlap<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    tiler.tile_raster(<span class="bu">str</span>(tile_folder<span class="op">/</span>t))</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    tiler.tile_vector(vector_folder<span class="op">/</span>shp_fname, min_area_pct<span class="op">=</span><span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Fix labelling, todo fix it in COCOProcessor</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> [outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'vector_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'vector_tiles'</span>) <span class="cf">if</span> f.endswith(<span class="st">'geojson'</span>)]</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> files: </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.read_file(f)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> box(<span class="op">*</span>gdf.total_bounds)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf.geometry.<span class="bu">buffer</span>(<span class="dv">0</span>) <span class="co"># fix faulty geometries</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf.<span class="bu">apply</span>(<span class="kw">lambda</span> row: fix_multipolys(row.geometry) <span class="cf">if</span> row.geometry.<span class="bu">type</span> <span class="op">==</span> <span class="st">'MultiPolygon'</span> </span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">else</span> shapely.geometry.Polygon(row.geometry.exterior), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.clip(gdf, bbox, keep_geom_type<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>        gdf.to_file(f, driver<span class="op">=</span><span class="st">'GeoJSON'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to COCO format</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> drone_detector.processing.coco <span class="im">import</span> <span class="op">*</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>deadwood_categories <span class="op">=</span> [</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'supercategory'</span>:<span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">1</span>, <span class="st">'name'</span>: <span class="st">'uprightwood'</span>},</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'supercategory'</span>:<span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">2</span>, <span class="st">'name'</span>: <span class="st">'groundwood'</span>},</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>coco_info <span class="op">=</span> {<span class="st">'description'</span>: <span class="st">'Train dataset for deadwood detection in Sudenpesänkangas'</span>,</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">'version'</span>: <span class="fl">0.1</span>,</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">'year'</span>: <span class="dv">2022</span>,</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">'contributor'</span>: <span class="st">'Janne Mäyrä'</span>,</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>             <span class="st">'date_created'</span>: date.today().strftime(<span class="st">"%Y/%m/</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>coco_licenses <span class="op">=</span> {}</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    coco_processor <span class="op">=</span> COCOProcessor(outpath<span class="op">/</span>p, outpath<span class="op">/</span>p, coco_info<span class="op">=</span>coco_info, coco_licenses<span class="op">=</span>coco_licenses,</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>                                  coco_categories<span class="op">=</span>deadwood_categories)</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>    coco_processor.shp_to_coco(<span class="st">'label'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine several coco-annotation .json files into one</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>full_coco <span class="op">=</span> <span class="va">None</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>image_id_modifier <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>ann_id_modifier <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'coco.json'</span>) <span class="im">as</span> f:</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>        coco <span class="op">=</span> json.load(f)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># update filename</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> coco[<span class="st">'images'</span>]:</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>        i[<span class="st">'file_name'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss">/raster_tiles/</span><span class="sc">{</span>i[<span class="st">'file_name'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> full_coco <span class="kw">is</span> <span class="va">None</span>: </span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>        full_coco <span class="op">=</span> coco</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>        image_id_modifier <span class="op">=</span> full_coco[<span class="st">'images'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>]</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>        ann_id_modifier <span class="op">=</span> full_coco[<span class="st">'annotations'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>]</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> coco[<span class="st">'images'</span>]:</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>            i[<span class="st">'id'</span>] <span class="op">+=</span> image_id_modifier</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> a <span class="kw">in</span> coco[<span class="st">'annotations'</span>]:</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>            a[<span class="st">'image_id'</span>] <span class="op">+=</span> image_id_modifier</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>            a[<span class="st">'id'</span>] <span class="op">+=</span> ann_id_modifier</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>        full_coco[<span class="st">'images'</span>].extend(coco[<span class="st">'images'</span>])</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>        full_coco[<span class="st">'annotations'</span>].extend(coco[<span class="st">'annotations'</span>])</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>        image_id_modifier <span class="op">=</span> full_coco[<span class="st">'images'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>        ann_id_modifier <span class="op">=</span> full_coco[<span class="st">'annotations'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(outpath.parents[<span class="dv">0</span>]<span class="op">/</span><span class="st">'sudenpesankangas_valid.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> outfile: json.dump(full_coco, outfile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>tile_folder <span class="op">=</span> Path(<span class="st">'../../data/raw/sudenpesankangas/virtual_plots/test/images/'</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>vector_folder <span class="op">=</span> Path(<span class="st">'../../data/raw/sudenpesankangas/virtual_plots/test/vectors/'</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>outpath <span class="op">=</span> Path(<span class="st">'../../data/processed/sudenpesankangas/test_512'</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>tiles <span class="op">=</span> os.listdir(tile_folder)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>vectors <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(vector_folder) <span class="cf">if</span> f.endswith(<span class="st">'geojson'</span>)]</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(tiles) <span class="op">==</span> <span class="bu">len</span>(vectors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> tiles:</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>]): os.makedirs(outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>])</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    shp_fname <span class="op">=</span> t.replace(<span class="st">'tif'</span>, <span class="st">'geojson'</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    tilesize <span class="op">=</span> <span class="dv">512</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    tiler <span class="op">=</span> Tiler(outpath<span class="op">=</span>outpath<span class="op">/</span>t[:<span class="op">-</span><span class="dv">4</span>], gridsize_x<span class="op">=</span>tilesize, gridsize_y<span class="op">=</span>tilesize, overlap<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    tiler.tile_raster(<span class="bu">str</span>(tile_folder<span class="op">/</span>t))</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    tiler.tile_vector(vector_folder<span class="op">/</span>shp_fname, min_area_pct<span class="op">=</span><span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Fix labelling, todo fix it in COCOProcessor</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> [outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'vector_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'vector_tiles'</span>) <span class="cf">if</span> f.endswith(<span class="st">'geojson'</span>)]</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> files: </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.read_file(f)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> box(<span class="op">*</span>gdf.total_bounds)</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf.geometry.<span class="bu">buffer</span>(<span class="dv">0</span>) <span class="co"># fix faulty geometries</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>        gdf[<span class="st">'geometry'</span>] <span class="op">=</span> gdf.<span class="bu">apply</span>(<span class="kw">lambda</span> row: fix_multipolys(row.geometry) <span class="cf">if</span> row.geometry.<span class="bu">type</span> <span class="op">==</span> <span class="st">'MultiPolygon'</span> </span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">else</span> shapely.geometry.Polygon(row.geometry.exterior), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.clip(gdf, bbox, keep_geom_type<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>        gdf.to_file(f, driver<span class="op">=</span><span class="st">'GeoJSON'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to COCO format</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> drone_detector.processing.coco <span class="im">import</span> <span class="op">*</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>deadwood_categories <span class="op">=</span> [</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'supercategory'</span>:<span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">1</span>, <span class="st">'name'</span>: <span class="st">'uprightwood'</span>},</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'supercategory'</span>:<span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">2</span>, <span class="st">'name'</span>: <span class="st">'groundwood'</span>},</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>coco_info <span class="op">=</span> {<span class="st">'description'</span>: <span class="st">'Test dataset for deadwood detection in Sudenpesänkangas'</span>,</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">'version'</span>: <span class="fl">0.1</span>,</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">'year'</span>: <span class="dv">2022</span>,</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">'contributor'</span>: <span class="st">'Janne Mäyrä'</span>,</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>             <span class="st">'date_created'</span>: date.today().strftime(<span class="st">"%Y/%m/</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>coco_licenses <span class="op">=</span> {}</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>    coco_processor <span class="op">=</span> COCOProcessor(outpath<span class="op">/</span>p, outpath<span class="op">/</span>p, coco_info<span class="op">=</span>coco_info, coco_licenses<span class="op">=</span>coco_licenses,</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>                                  coco_categories<span class="op">=</span>deadwood_categories)</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>    coco_processor.shp_to_coco(<span class="st">'label'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine several coco-annotation .json files into one</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>full_coco <span class="op">=</span> <span class="va">None</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>image_id_modifier <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>ann_id_modifier <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> os.listdir(outpath):</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(outpath<span class="op">/</span>p<span class="op">/</span><span class="st">'coco.json'</span>) <span class="im">as</span> f:</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>        coco <span class="op">=</span> json.load(f)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># update filename</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> coco[<span class="st">'images'</span>]:</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>        i[<span class="st">'file_name'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss">/raster_tiles/</span><span class="sc">{</span>i[<span class="st">'file_name'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> full_coco <span class="kw">is</span> <span class="va">None</span>: </span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>        full_coco <span class="op">=</span> coco</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>        image_id_modifier <span class="op">=</span> full_coco[<span class="st">'images'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>]</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>        ann_id_modifier <span class="op">=</span> full_coco[<span class="st">'annotations'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>]</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> coco[<span class="st">'images'</span>]:</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>            i[<span class="st">'id'</span>] <span class="op">+=</span> image_id_modifier</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> a <span class="kw">in</span> coco[<span class="st">'annotations'</span>]:</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>            a[<span class="st">'image_id'</span>] <span class="op">+=</span> image_id_modifier</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>            a[<span class="st">'id'</span>] <span class="op">+=</span> ann_id_modifier</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>        full_coco[<span class="st">'images'</span>].extend(coco[<span class="st">'images'</span>])</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>        full_coco[<span class="st">'annotations'</span>].extend(coco[<span class="st">'annotations'</span>])</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>        image_id_modifier <span class="op">=</span> full_coco[<span class="st">'images'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>        ann_id_modifier <span class="op">=</span> full_coco[<span class="st">'annotations'</span>][<span class="op">-</span><span class="dv">1</span>][<span class="st">'id'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(outpath.parents[<span class="dv">0</span>]<span class="op">/</span><span class="st">'sudenpesankangas_test.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> outfile: json.dump(full_coco, outfile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="./0_index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Introduction</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./2_comparing_annotations_and_field_data.html" class="pagination-link">
        <span class="nav-page-text">Comparison of plot characteristics and digitized deadwood</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>