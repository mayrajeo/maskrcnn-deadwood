<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Janne Mäyrä">
<meta name="dcterms.date" content="2022-12-22">

<title>Automated deadwood detection from UAV RGB imagery - Scene level results</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./6_result_comparison_with_field_data.html" rel="next">
<link href="./4_patch_level_results.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Automated deadwood detection from UAV RGB imagery - Scene level results">
<meta property="og:description" content="As patch-level data and results are not really useful for our purposes, here we run the predictions for larger scenes.">
<meta property="og:site-name" content="Automated deadwood detection from UAV RGB imagery">
<meta name="twitter:title" content="Automated deadwood detection from UAV RGB imagery - Scene level results">
<meta name="twitter:description" content="As patch-level data and results are not really useful for our purposes, here we run the predictions for larger scenes.">
<meta name="twitter:creator" content="@mayrajeo">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Automated deadwood detection from UAV RGB imagery</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jaeeolma/maskrcnn-deadwood/"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Scene level results</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./0_index.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Workflow</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1_dataset_description_and_generation.html" class="sidebar-item-text sidebar-link">Dataset description and generation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2_comparing_annotations_and_field_data.html" class="sidebar-item-text sidebar-link">Comparison of plot characteristics and digitized deadwood</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3_mask_rcnn_model_training.html" class="sidebar-item-text sidebar-link">Mask R-CNN model training</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4_patch_level_results.html" class="sidebar-item-text sidebar-link">Patch level results</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5_scene_level_results.html" class="sidebar-item-text sidebar-link active">Scene level results</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./6_result_comparison_with_field_data.html" class="sidebar-item-text sidebar-link">Result comparison with field data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./7_deriving_standwise_metrics_for_evo.html" class="sidebar-item-text sidebar-link">Deriving deadwood statistics for full Evo study area</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./8_configs.html" class="sidebar-item-text sidebar-link">Running models with your own data</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#hiidenportti-test-set" id="toc-hiidenportti-test-set" class="nav-link active" data-scroll-target="#hiidenportti-test-set"><span class="toc-section-number">1</span>  Hiidenportti test set</a>
  <ul class="collapse">
  <li><a href="#no-overlap-no-post-processing" id="toc-no-overlap-no-post-processing" class="nav-link" data-scroll-target="#no-overlap-no-post-processing"><span class="toc-section-number">1.1</span>  No overlap, no post-processing</a></li>
  <li><a href="#half-patch-overlap-and-edge-filtering" id="toc-half-patch-overlap-and-edge-filtering" class="nav-link" data-scroll-target="#half-patch-overlap-and-edge-filtering"><span class="toc-section-number">1.2</span>  Half patch overlap and edge filtering</a></li>
  <li><a href="#overlap-edge-filtering-and-mask-merging" id="toc-overlap-edge-filtering-and-mask-merging" class="nav-link" data-scroll-target="#overlap-edge-filtering-and-mask-merging"><span class="toc-section-number">1.3</span>  Overlap, edge filtering and mask merging</a></li>
  </ul></li>
  <li><a href="#full-evo-dataset" id="toc-full-evo-dataset" class="nav-link" data-scroll-target="#full-evo-dataset"><span class="toc-section-number">2</span>  Full Evo dataset</a>
  <ul class="collapse">
  <li><a href="#no-overlap-no-post-processing-1" id="toc-no-overlap-no-post-processing-1" class="nav-link" data-scroll-target="#no-overlap-no-post-processing-1"><span class="toc-section-number">2.1</span>  No overlap, no post-processing</a></li>
  <li><a href="#half-patch-overlap-and-edge-filtering-1" id="toc-half-patch-overlap-and-edge-filtering-1" class="nav-link" data-scroll-target="#half-patch-overlap-and-edge-filtering-1"><span class="toc-section-number">2.2</span>  Half patch overlap and edge filtering</a></li>
  <li><a href="#overlap-edge-filtering-and-mask-merging-1" id="toc-overlap-edge-filtering-and-mask-merging-1" class="nav-link" data-scroll-target="#overlap-edge-filtering-and-mask-merging-1"><span class="toc-section-number">2.3</span>  Overlap, edge filtering and mask merging</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/jaeeolma/maskrcnn-deadwood/blob/main/notebooks/5_scene_level_results.ipynb" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Scene level results</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Janne Mäyrä </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 22, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> drone_detector.utils <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> drone_detector.imports <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> drone_detector.metrics <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="st">'..'</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.postproc_functions <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>tqdm.pandas()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As patch-level data and results are not really useful for our purposes, here we run the predictions for larger scenes. Each plot is tiled to 512x512px patches, possibly with 256px overlap and afterwards the predictions are collated and optionally cleaned so that the amount of overlapping predictions is lower.</p>
<section id="hiidenportti-test-set" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Hiidenportti test set</h1>
<p>As Hiidenportti test set is so small, we can run predictions here if needed.</p>
<section id="no-overlap-no-post-processing" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="no-overlap-no-post-processing"><span class="header-section-number">1.1</span> No overlap, no post-processing</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> drone_detector.engines.detectron2.predict <span class="im">import</span> predict_instance_masks</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>raw_path <span class="op">=</span> Path(<span class="st">'../../data/raw/hiidenportti/virtual_plots/buffered_test/images'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>test_rasters <span class="op">=</span> [raw_path<span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(raw_path) <span class="cf">if</span> f.endswith(<span class="st">'tif'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Template folder has the following structure:</p>
<pre><code>template_folder
|-predicted_vectors
|-raster_tiles
|-vector_tiles
|-raw_preds</code></pre>
<p>Where <code>raster_tiles</code> and <code>vector_tiles</code> are symbolic links pointing to corresponding data directories, and <code>predicted_vectors</code> and <code>raw_preds</code> are empty folders for predictions.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>pred_outpath <span class="op">=</span> Path(<span class="st">'../results/hp_unprocessed_new/'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(pred_outpath):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    shutil.copytree(<span class="st">'../results/template_folder/'</span>, pred_outpath, symlinks<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> test_rasters:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    outfile_name <span class="op">=</span> pred_outpath<span class="op">/</span><span class="ss">f'raw_preds/</span><span class="sc">{</span><span class="bu">str</span>(t)<span class="sc">.</span>split(<span class="st">"/"</span>)[<span class="op">-</span><span class="dv">1</span>][:<span class="op">-</span><span class="dv">4</span>]<span class="sc">}</span><span class="ss">.geojson'</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    predict_instance_masks(path_to_model_files<span class="op">=</span><span class="st">'../models/hiidenportti/mask_rcnn_R_101_FPN_3x/'</span>, </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                           path_to_image<span class="op">=</span><span class="bu">str</span>(t),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                           outfile<span class="op">=</span><span class="bu">str</span>(outfile_name),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                           processing_dir<span class="op">=</span><span class="st">'temp'</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                           tile_size<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                           tile_overlap<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                           smooth_preds<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                           use_tta<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                           coco_set<span class="op">=</span><span class="st">'../../data/processed/hiidenportti/hiidenportti_valid.json'</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                           postproc_results<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>raw_res_path <span class="op">=</span> pred_outpath</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>truth_shps <span class="op">=</span> <span class="bu">sorted</span>([raw_res_path<span class="op">/</span><span class="st">'vector_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(raw_res_path<span class="op">/</span><span class="st">'vector_tiles'</span>)])</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>raw_shps <span class="op">=</span> <span class="bu">sorted</span>([raw_res_path<span class="op">/</span><span class="st">'raw_preds'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(raw_res_path<span class="op">/</span><span class="st">'raw_preds'</span>)])</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>rasters <span class="op">=</span> <span class="bu">sorted</span>([raw_res_path<span class="op">/</span><span class="st">'raster_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(raw_res_path<span class="op">/</span><span class="st">'raster_tiles'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>“Raw” predictions are modified as such: 1. Invalid polygons are fixed to be valid polygons. MultiPolygon masks are replaced with the largest single polygon of the multipoly. 2. Extent is clipped to be same as the corresponding ground truth data 3. Label numbering is adjusted 4. Polygons with area less than 16² pixels are discarded</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p, t <span class="kw">in</span> <span class="bu">zip</span>(raw_shps, truth_shps):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> gpd.read_file(p)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    temp_truth <span class="op">=</span> gpd.read_file(t)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> gpd.clip(temp_pred, box(<span class="op">*</span>temp_truth.total_bounds))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    temp_pred[<span class="st">'geometry'</span>] <span class="op">=</span> temp_pred.<span class="bu">apply</span>(<span class="kw">lambda</span> row: fix_multipolys(row.geometry) </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                                            <span class="cf">if</span> row.geometry.<span class="bu">type</span> <span class="op">==</span> <span class="st">'MultiPolygon'</span> </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                                            <span class="cf">else</span> shapely.geometry.Polygon(row.geometry.exterior), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    temp_pred[<span class="st">'label'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> temp_pred[temp_pred.geometry.area <span class="op">&gt;</span> <span class="dv">16</span><span class="op">*</span><span class="fl">0.04</span><span class="op">**</span><span class="dv">2</span>]</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    temp_pred.to_file(raw_res_path<span class="op">/</span><span class="st">'predicted_vectors'</span><span class="op">/</span>p.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>pred_shps <span class="op">=</span> <span class="bu">sorted</span>([raw_res_path<span class="op">/</span><span class="st">'predicted_vectors'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(raw_res_path<span class="op">/</span><span class="st">'predicted_vectors'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Collate predictions and annotations so that IoU and such is easy to compute.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>truths <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p, t <span class="kw">in</span> <span class="bu">zip</span>(pred_shps, truth_shps):</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> gpd.read_file(p)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    temp_truth <span class="op">=</span> gpd.read_file(t)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> truths <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        truths <span class="op">=</span> temp_truth</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> temp_pred</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        truths <span class="op">=</span> pd.concat((truths, temp_truth))</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> pd.concat((preds, temp_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Fix labeling.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>preds[<span class="st">'layer'</span>] <span class="op">=</span> preds.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="st">'groundwood'</span> <span class="cf">if</span> row.label <span class="op">==</span> <span class="dv">2</span> <span class="cf">else</span> <span class="st">'uprightwood'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Check the number of predictions. The models have found almost 1500 more deadwood instances at this point.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>preds.shape, truths.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>((3444, 4), (1741, 6))</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>preds.label.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>2    2790
1     654
Name: label, dtype: int64</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>dis_truths <span class="op">=</span> truths.dissolve(by<span class="op">=</span><span class="st">'layer'</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>dis_preds <span class="op">=</span> preds.dissolve(by<span class="op">=</span><span class="st">'layer'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Check IoU-score.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>poly_IoU(dis_truths, dis_preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>layer
groundwood     0.472870
uprightwood    0.460234
dtype: float64</code></pre>
</div>
</div>
<p>Run GisCOCOeval, which converts georeferenced vector files to COCO-annotations and runs the metrics.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>deadwood_categories <span class="op">=</span> [{<span class="st">'supercategory'</span>: <span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">1</span>, <span class="st">'name'</span>:<span class="st">'uprightwood'</span>},</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                       {<span class="st">'supercategory'</span>: <span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">2</span>, <span class="st">'name'</span>:<span class="st">'groundwood'</span>}]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>raw_coco_eval <span class="op">=</span> GisCOCOeval(raw_res_path, raw_res_path, </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                            <span class="va">None</span>, <span class="va">None</span>, deadwood_categories)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>raw_coco_eval.prepare_data(gt_label_col<span class="op">=</span><span class="st">'layer'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a3d5fd88dd374b908e5fc9592fa87cc7","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c3a18d48fb4549338e793c037ebe66a0","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>raw_coco_eval.prepare_eval()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>loading annotations into memory...
Done (t=0.03s)
creating index...
index created!
Loading and preparing results...
DONE (t=0.03s)
creating index...
index created!</code></pre>
</div>
</div>
<p>As the scenes can contain more than 1000 annotations, set <code>maxDets</code> to larger values than default.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>raw_coco_eval.coco_eval.params.maxDets <span class="op">=</span> [<span class="dv">1000</span>, <span class="dv">10000</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>raw_coco_eval.evaluate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Evaluating for category uprightwood
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=0.81s).
Accumulating evaluation results...
DONE (t=0.01s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=10000 ] = 0.348
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=10000 ] = 0.677
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=10000 ] = 0.325
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=10000 ] = 0.217
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=10000 ] = 0.396
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=10000 ] = 1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.466
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.387
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.497
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 1.000

Evaluating for category groundwood
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=11.59s).
Accumulating evaluation results...
DONE (t=0.02s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=10000 ] = 0.202
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=10000 ] = 0.525
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=10000 ] = 0.104
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=10000 ] = 0.204
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=10000 ] = 0.160
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=10000 ] = -1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.342
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.347
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.200
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = -1.000

Evaluating for full data...
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=12.39s).
Accumulating evaluation results...
DONE (t=0.03s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=10000 ] = 0.275
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=10000 ] = 0.601
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=10000 ] = 0.214
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=10000 ] = 0.210
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=10000 ] = 0.278
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=10000 ] = 1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.404
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.367
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.349
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 1.000</code></pre>
</div>
</div>
<p>Compared to the patch-level results, the AP50 score is around 0.2 lower than patch-level results. However, edges are not handled in any way in this processing level.</p>
<p>Get the number of false positives (FP), true positives (TP) and false negatives (FN). Object detection has infinite number of true negatives so we are not interested in them.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>fp_cols <span class="op">=</span> [<span class="ss">f'FP_</span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">round</span>(i, <span class="dv">2</span>)<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> np.arange(<span class="fl">0.5</span>, <span class="fl">1.04</span>, <span class="fl">0.05</span>)]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>tp_cols <span class="op">=</span> [<span class="ss">f'TP_</span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">round</span>(i, <span class="dv">2</span>)<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> np.arange(<span class="fl">0.5</span>, <span class="fl">1.03</span>, <span class="fl">0.05</span>)]</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>tp_truths <span class="op">=</span> truths.copy()</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>tp_truths.rename(columns<span class="op">=</span>{<span class="st">'groundwood'</span>:<span class="st">'label'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>truth_sindex <span class="op">=</span> tp_truths.sindex</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>fp_preds <span class="op">=</span> preds.copy()</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>pred_sindex <span class="op">=</span> fp_preds.sindex</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>tp_truths[tp_cols] <span class="op">=</span> tp_truths.progress_apply(<span class="kw">lambda</span> row: is_true_positive(row, fp_preds, pred_sindex), </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>                                              axis<span class="op">=</span><span class="dv">1</span>, result_type<span class="op">=</span><span class="st">'expand'</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>fp_preds[fp_cols] <span class="op">=</span> fp_preds.progress_apply(<span class="kw">lambda</span> row: is_false_positive(row, tp_truths, truth_sindex,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>                                                                            fp_preds, pred_sindex),</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>                                            axis<span class="op">=</span><span class="dv">1</span>, result_type<span class="op">=</span><span class="st">'expand'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"be76f28003a84ebe88c98902dda80573","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a4a8f9b388a2415ebbe0b1de379a01a0","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(fp_preds.layer, fp_preds[<span class="st">'FP_0.5'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>FP_0.5</th>
      <th>FP</th>
      <th>TP</th>
      <th>All</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>1837</td>
      <td>953</td>
      <td>2790</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>382</td>
      <td>272</td>
      <td>654</td>
    </tr>
    <tr>
      <th>All</th>
      <td>2219</td>
      <td>1225</td>
      <td>3444</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(tp_truths.layer, tp_truths[<span class="st">'TP_0.5'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>TP_0.5</th>
      <th>FN</th>
      <th>TP</th>
      <th>All</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>448</td>
      <td>953</td>
      <td>1401</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>68</td>
      <td>272</td>
      <td>340</td>
    </tr>
    <tr>
      <th>All</th>
      <td>516</td>
      <td>1225</td>
      <td>1741</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>From these we can get both precision and recall: <span class="math inline">\(Precision = \frac{tp}{tp+fp}, Recall = \frac{tp}{tp+fn}\)</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Precision for fallen deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">953</span><span class="op">/</span><span class="dv">2790</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Recall for fallen deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">953</span><span class="op">/</span><span class="dv">1401</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Precision for fallen deadwood with IoU threshold of 0.5 is 0.34
Recall for fallen deadwood with IoU threshold of 0.5 is 0.68</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Precision for standing deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">272</span><span class="op">/</span><span class="dv">654</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Recall for standing deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">212</span><span class="op">/</span><span class="dv">340</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Precision for standing deadwood with IoU threshold of 0.5 is 0.42
Recall for standing deadwood with IoU threshold of 0.5 is 0.62</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Overall precision with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">1225</span><span class="op">/</span><span class="dv">3444</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Overall recall with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">1225</span><span class="op">/</span><span class="dv">1741</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Overall precision with IoU threshold of 0.5 is 0.36
Overall recall with IoU threshold of 0.5 is 0.70</code></pre>
</div>
</div>
</section>
<section id="half-patch-overlap-and-edge-filtering" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="half-patch-overlap-and-edge-filtering"><span class="header-section-number">1.2</span> Half patch overlap and edge filtering</h2>
<p>For this postprocessing method, mosaics are tiled so that the sliding window moves half tile lenght. For example, when moving row-wise, the first bottom-left coordinates are (0,0), and next ones (256,0), (512,0)… and same is done column-wise. We discard all predicted polygons whose centroid point is not within the half-overlap area. For instance, for first tile (bottom left (0,0)), the x-coordinate must be between 128 and 384, for second tile (256,0) between 384 and 640, and likewise for y-coordinates. This method discards almost 75% of all predictions in the scenes as they are either overlapping or cut in half in the patch borders.</p>
<p>The images used for predictions are buffered so that the whole area is covered, considering the discarding process.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>pred_outpath <span class="op">=</span> Path(<span class="st">'../results/hp_overlap_filter_new/'</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(pred_outpath):</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    shutil.copytree(<span class="st">'../results/template_folder/'</span>, pred_outpath, symlinks<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>raw_path <span class="op">=</span> Path(<span class="st">'../../data/raw/hiidenportti/virtual_plots/buffered_test/images'</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>test_rasters <span class="op">=</span> [raw_path<span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(raw_path) <span class="cf">if</span> f.endswith(<span class="st">'tif'</span>)]</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> test_rasters:</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    outfile_name <span class="op">=</span> pred_outpath<span class="op">/</span><span class="ss">f'raw_preds/</span><span class="sc">{</span><span class="bu">str</span>(t)<span class="sc">.</span>split(<span class="st">"/"</span>)[<span class="op">-</span><span class="dv">1</span>][:<span class="op">-</span><span class="dv">4</span>]<span class="sc">}</span><span class="ss">.geojson'</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    predict_instance_masks(path_to_model_files<span class="op">=</span><span class="st">'../models/hiidenportti/mask_rcnn_R_101_FPN_3x/'</span>, </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>                           path_to_image<span class="op">=</span><span class="bu">str</span>(t),</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>                           outfile<span class="op">=</span><span class="bu">str</span>(outfile_name),</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>                           processing_dir<span class="op">=</span><span class="st">'temp'</span>,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>                           tile_size<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>                           tile_overlap<span class="op">=</span><span class="dv">256</span>,</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>                           smooth_preds<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>                           use_tta<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>                           coco_set<span class="op">=</span><span class="st">'../../data/processed/hiidenportti/hiidenportti_valid.json'</span>,</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>                           postproc_results<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Modify as previously.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>hp_res_path <span class="op">=</span> pred_outpath</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>truth_shps <span class="op">=</span> <span class="bu">sorted</span>([hp_res_path<span class="op">/</span><span class="st">'vector_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(hp_res_path<span class="op">/</span><span class="st">'vector_tiles'</span>)])</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>hp_raw_shps <span class="op">=</span> <span class="bu">sorted</span>([hp_res_path<span class="op">/</span><span class="st">'raw_preds'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(hp_res_path<span class="op">/</span><span class="st">'raw_preds'</span>)])</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>rasters <span class="op">=</span> <span class="bu">sorted</span>([hp_res_path<span class="op">/</span><span class="st">'raster_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(hp_res_path<span class="op">/</span><span class="st">'raster_tiles'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p, t <span class="kw">in</span> <span class="bu">zip</span>(hp_raw_shps, truth_shps):</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> gpd.read_file(p)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    temp_truth <span class="op">=</span> gpd.read_file(t)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> gpd.clip(temp_pred, box(<span class="op">*</span>temp_truth.total_bounds))</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    temp_pred[<span class="st">'geometry'</span>] <span class="op">=</span> temp_pred.<span class="bu">apply</span>(<span class="kw">lambda</span> row: fix_multipolys(row.geometry) </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>                                            <span class="cf">if</span> row.geometry.<span class="bu">type</span> <span class="op">==</span> <span class="st">'MultiPolygon'</span> </span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                                            <span class="cf">else</span> shapely.geometry.Polygon(row.geometry.exterior), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    temp_pred[<span class="st">'label'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> temp_pred[temp_pred.geometry.area <span class="op">&gt;</span> <span class="dv">16</span><span class="op">*</span><span class="fl">0.04</span><span class="op">**</span><span class="dv">2</span>]</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    temp_pred.to_file(hp_res_path<span class="op">/</span><span class="st">'predicted_vectors'</span><span class="op">/</span>p.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>pred_shps <span class="op">=</span> <span class="bu">sorted</span>([hp_res_path<span class="op">/</span><span class="st">'predicted_vectors'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(hp_res_path<span class="op">/</span><span class="st">'predicted_vectors'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Collate all predictions into single dataframes</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>truths <span class="op">=</span> <span class="va">None</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> <span class="va">None</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p, t <span class="kw">in</span> <span class="bu">zip</span>(pred_shps, truth_shps):</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> gpd.read_file(p)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    temp_truth <span class="op">=</span> gpd.read_file(t)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> truths <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>        truths <span class="op">=</span> temp_truth</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> temp_pred</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>        truths <span class="op">=</span> pd.concat((truths, temp_truth))</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> pd.concat((preds, temp_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>preds[<span class="st">'layer'</span>] <span class="op">=</span> preds.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="st">'groundwood'</span> <span class="cf">if</span> row.label <span class="op">==</span> <span class="dv">2</span> <span class="cf">else</span> <span class="st">'uprightwood'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The total amount after cleaning is similar than before.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>preds.layer.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>groundwood     2698
uprightwood     619
Name: layer, dtype: int64</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>dis_truths <span class="op">=</span> truths.dissolve(by<span class="op">=</span><span class="st">'layer'</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>dis_preds <span class="op">=</span> preds.dissolve(by<span class="op">=</span><span class="st">'layer'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>But IoU, especially for standing deadwood increases.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>poly_IoU(dis_truths, dis_preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>layer
groundwood     0.487089
uprightwood    0.503599
dtype: float64</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>deadwood_categories <span class="op">=</span> [{<span class="st">'supercategory'</span>: <span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">1</span>, <span class="st">'name'</span>:<span class="st">'uprightwood'</span>},</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                       {<span class="st">'supercategory'</span>: <span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">2</span>, <span class="st">'name'</span>:<span class="st">'groundwood'</span>}]</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>hp_coco_eval <span class="op">=</span> GisCOCOeval(hp_res_path, hp_res_path, </span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>                            <span class="va">None</span>, <span class="va">None</span>, deadwood_categories)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>hp_coco_eval.prepare_data(gt_label_col<span class="op">=</span><span class="st">'layer'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2ce3d7c8a21b4abda327842116df60b3","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"38d905fc758d4dcba7bad8729bb40db7","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>hp_coco_eval.prepare_eval()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>loading annotations into memory...
Done (t=0.03s)
creating index...
index created!
Loading and preparing results...
DONE (t=0.03s)
creating index...
index created!</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>hp_coco_eval.coco_eval.params.maxDets <span class="op">=</span> [<span class="dv">1000</span>, <span class="dv">10000</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>hp_coco_eval.evaluate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Evaluating for category uprightwood
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=0.76s).
Accumulating evaluation results...
DONE (t=0.01s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=10000 ] = 0.447
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=10000 ] = 0.780
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=10000 ] = 0.479
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=10000 ] = 0.296
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=10000 ] = 0.505
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=10000 ] = 1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.545
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.428
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.591
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 1.000

Evaluating for category groundwood
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=12.06s).
Accumulating evaluation results...
DONE (t=0.02s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=10000 ] = 0.266
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=10000 ] = 0.652
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=10000 ] = 0.145
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=10000 ] = 0.269
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=10000 ] = 0.211
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=10000 ] = -1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.389
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.394
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.280
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = -1.000

Evaluating for full data...
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=12.87s).
Accumulating evaluation results...
DONE (t=0.03s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=10000 ] = 0.356
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=10000 ] = 0.716
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=10000 ] = 0.312
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=10000 ] = 0.282
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=10000 ] = 0.358
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=10000 ] = 1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.467
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.411
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.436
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 1.000</code></pre>
</div>
</div>
<p>Overall AP50 increases by around 0.1 with this kind of post-processing.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>tp_truths <span class="op">=</span> truths.copy()</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>tp_truths.rename(columns<span class="op">=</span>{<span class="st">'groundwood'</span>:<span class="st">'label'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>truth_sindex <span class="op">=</span> tp_truths.sindex</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>fp_preds <span class="op">=</span> preds.copy()</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>pred_sindex <span class="op">=</span> fp_preds.sindex</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>tp_truths[tp_cols] <span class="op">=</span> tp_truths.progress_apply(<span class="kw">lambda</span> row: is_true_positive(row, fp_preds, pred_sindex), </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>                                              axis<span class="op">=</span><span class="dv">1</span>, result_type<span class="op">=</span><span class="st">'expand'</span>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>fp_preds[fp_cols] <span class="op">=</span> fp_preds.progress_apply(<span class="kw">lambda</span> row: is_false_positive(row, tp_truths, truth_sindex,</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>                                                                            fp_preds, pred_sindex),</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>                                            axis<span class="op">=</span><span class="dv">1</span>, result_type<span class="op">=</span><span class="st">'expand'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9f83d4eb180845668f9824f177fe79ea","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"accc7f4234df4c4abd18437346951537","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(fp_preds.layer, fp_preds[<span class="st">'FP_0.5'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>FP_0.5</th>
      <th>FP</th>
      <th>TP</th>
      <th>All</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>1636</td>
      <td>1062</td>
      <td>2698</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>318</td>
      <td>301</td>
      <td>619</td>
    </tr>
    <tr>
      <th>All</th>
      <td>1954</td>
      <td>1363</td>
      <td>3317</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(tp_truths.layer, tp_truths[<span class="st">'TP_0.5'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>TP_0.5</th>
      <th>FN</th>
      <th>TP</th>
      <th>All</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>339</td>
      <td>1062</td>
      <td>1401</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>39</td>
      <td>301</td>
      <td>340</td>
    </tr>
    <tr>
      <th>All</th>
      <td>378</td>
      <td>1363</td>
      <td>1741</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p><span class="math inline">\(Precision = \frac{tp}{tp+fp}, Recall = \frac{tp}{tp+fn}\)</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Precision for fallen deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">1062</span><span class="op">/</span><span class="dv">2698</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Recall for fallen deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">1062</span><span class="op">/</span><span class="dv">1401</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Precision for fallen deadwood with IoU threshold of 0.5 is 0.39
Recall for fallen deadwood with IoU threshold of 0.5 is 0.76</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Precision for standing deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">301</span><span class="op">/</span><span class="dv">619</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Recall for standing deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">301</span><span class="op">/</span><span class="dv">340</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Precision for standing deadwood with IoU threshold of 0.5 is 0.49
Recall for standing deadwood with IoU threshold of 0.5 is 0.89</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Overall precision with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">1363</span><span class="op">/</span><span class="dv">3317</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Overall recall with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">1363</span><span class="op">/</span><span class="dv">1741</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Overall precision with IoU threshold of 0.5 is 0.41
Overall recall with IoU threshold of 0.5 is 0.78</code></pre>
</div>
</div>
</section>
<section id="overlap-edge-filtering-and-mask-merging" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="overlap-edge-filtering-and-mask-merging"><span class="header-section-number">1.3</span> Overlap, edge filtering and mask merging</h2>
<p>Mask merging is built on previous predictions. In this step, for each polygon we check whether the ratio between intersection with any other polygon of the same class and the area of the polygon is more than 0.2. If yes, the polygon is merged to the other polygon with which it had intersection-over-area ratio.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>merge_outpath <span class="op">=</span> Path(<span class="st">'../results/hp_merge_new//'</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(merge_outpath):</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    shutil.copytree(<span class="st">'../results/template_folder/'</span>, merge_outpath, symlinks<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Two iterations of merging is usually enough.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> pred_shps:</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    gdf_temp <span class="op">=</span> gpd.read_file(r)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    standing <span class="op">=</span> gdf_temp[gdf_temp.label<span class="op">==</span><span class="dv">1</span>].copy()</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    fallen <span class="op">=</span> gdf_temp[gdf_temp.label<span class="op">==</span><span class="dv">2</span>].copy()</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    standing <span class="op">=</span> merge_polys(standing, <span class="fl">0.2</span>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    fallen <span class="op">=</span> merge_polys(fallen, <span class="fl">0.2</span>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    standing <span class="op">=</span> merge_polys(standing, <span class="fl">0.2</span>)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    fallen <span class="op">=</span> merge_polys(fallen, <span class="fl">0.2</span>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    gdf_merged <span class="op">=</span> pd.concat((standing, fallen))</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    gdf_merged.to_file(merge_outpath<span class="op">/</span><span class="st">'predicted_vectors'</span><span class="op">/</span>r.name, driver<span class="op">=</span><span class="st">'GeoJSON'</span>)</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    gdf_merged <span class="op">=</span> <span class="va">None</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    gdf_temp <span class="op">=</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>merge_outpath</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Path('../results/hp_merge_new')</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>merged_coco_eval <span class="op">=</span> GisCOCOeval(merge_outpath, merge_outpath, <span class="va">None</span>, <span class="va">None</span>, deadwood_categories)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>merged_coco_eval.prepare_data(gt_label_col<span class="op">=</span><span class="st">'layer'</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>merged_coco_eval.prepare_eval()</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>merged_coco_eval.evaluate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4cfd945abc2f4bc79145bdb75a719ed4","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0beb06be20794ecc8e270b324a099354","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>loading annotations into memory...
Done (t=0.03s)
creating index...
index created!
Loading and preparing results...
DONE (t=0.02s)
creating index...
index created!

Evaluating for category uprightwood
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=0.68s).
Accumulating evaluation results...
DONE (t=0.01s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.436
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=1000 ] = 0.761
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=1000 ] = 0.465
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.288
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.495
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.399
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.246
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.460
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 1.000

Evaluating for category groundwood
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=9.05s).
Accumulating evaluation results...
DONE (t=0.01s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.246
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=1000 ] = 0.605
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=1000 ] = 0.130
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.248
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.207
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = -1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.151
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.153
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.082
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = -1.000

Evaluating for full data...
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=9.90s).
Accumulating evaluation results...
DONE (t=0.02s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.341
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=1000 ] = 0.683
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=1000 ] = 0.297
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.268
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.351
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.275
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.200
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.271
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 1.000</code></pre>
</div>
</div>
<p>This usually worsens the results a bit, but the produced results are better suited for deriving forest charasteristics, as the number of overlapping detected instances decrease significantly.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>preds.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>standing <span class="op">=</span> merge_polys(preds[preds.label <span class="op">==</span> <span class="dv">1</span>].copy(), <span class="fl">0.2</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>fallen <span class="op">=</span> merge_polys(preds[preds.label <span class="op">==</span> <span class="dv">2</span>].copy(), <span class="fl">0.2</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>standing <span class="op">=</span> merge_polys(standing, <span class="fl">0.2</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>fallen <span class="op">=</span> merge_polys(fallen, <span class="fl">0.2</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>preds_merged <span class="op">=</span> pd.concat((standing, fallen))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>619it [00:02, 250.70it/s]
2698it [00:23, 113.43it/s]
574it [00:02, 284.39it/s]
2074it [00:13, 155.47it/s]</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>preds_merged[<span class="st">'layer'</span>] <span class="op">=</span> preds_merged.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="st">'groundwood'</span> <span class="cf">if</span> row.label <span class="op">==</span> <span class="dv">2</span> <span class="cf">else</span> <span class="st">'uprightwood'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>preds_merged.layer.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>groundwood     2003
uprightwood     564
Name: layer, dtype: int64</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>tp_truths <span class="op">=</span> truths.copy()</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>tp_truths.rename(columns<span class="op">=</span>{<span class="st">'groundwood'</span>:<span class="st">'label'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>truth_sindex <span class="op">=</span> tp_truths.sindex</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>fp_preds_merged <span class="op">=</span> preds_merged.copy()</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>pred_sindex <span class="op">=</span> fp_preds_merged.sindex</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>tp_truths[tp_cols] <span class="op">=</span> tp_truths.progress_apply(<span class="kw">lambda</span> row: is_true_positive(row, fp_preds_merged, pred_sindex), </span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>                                              axis<span class="op">=</span><span class="dv">1</span>, result_type<span class="op">=</span><span class="st">'expand'</span>)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>fp_preds_merged[fp_cols] <span class="op">=</span> fp_preds_merged.progress_apply(<span class="kw">lambda</span> row: is_false_positive(row, tp_truths, truth_sindex,</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>                                                                            fp_preds_merged, pred_sindex),</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>                                            axis<span class="op">=</span><span class="dv">1</span>, result_type<span class="op">=</span><span class="st">'expand'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c23dd5b275af4f0aa3e5d2b48a1a5e2d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"72c90c41589d461f9a9685654da5bfd5","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(fp_preds_merged.layer, fp_preds_merged[<span class="st">'FP_0.5'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>FP_0.5</th>
      <th>FP</th>
      <th>TP</th>
      <th>All</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>1036</td>
      <td>967</td>
      <td>2003</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>271</td>
      <td>293</td>
      <td>564</td>
    </tr>
    <tr>
      <th>All</th>
      <td>1307</td>
      <td>1260</td>
      <td>2567</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(tp_truths.layer, tp_truths[<span class="st">'TP_0.5'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>TP_0.5</th>
      <th>FN</th>
      <th>TP</th>
      <th>All</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>434</td>
      <td>967</td>
      <td>1401</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>47</td>
      <td>293</td>
      <td>340</td>
    </tr>
    <tr>
      <th>All</th>
      <td>481</td>
      <td>1260</td>
      <td>1741</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p><span class="math inline">\(Precision = \frac{tp}{tp+fp}, Recall = \frac{tp}{tp+fn}\)</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Precision for fallen deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">967</span><span class="op">/</span><span class="dv">2003</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Recall for fallen deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">967</span><span class="op">/</span><span class="dv">1401</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Precision for fallen deadwood with IoU threshold of 0.5 is 0.48
Recall for fallen deadwood with IoU threshold of 0.5 is 0.69</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Precision for standing deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">293</span><span class="op">/</span><span class="dv">564</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Recall for standing deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">293</span><span class="op">/</span><span class="dv">340</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Precision for standing deadwood with IoU threshold of 0.5 is 0.52
Recall for standing deadwood with IoU threshold of 0.5 is 0.86</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Overall precision with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">1260</span><span class="op">/</span><span class="dv">2567</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Overall recall with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">1260</span><span class="op">/</span><span class="dv">1741</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Overall precision with IoU threshold of 0.5 is 0.49
Overall recall with IoU threshold of 0.5 is 0.72</code></pre>
</div>
</div>
<p>As the postprocessing merges data instead of dropping less certain predictions, total area and IoU remain the same as in previous step.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>preds_merged.to_file(<span class="st">'../results/hiidenportti/merged_all_20220823.geojson'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="full-evo-dataset" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Full Evo dataset</h1>
<p>Running predictions for Evo dataset takes so much time that it has been done separately.</p>
<section id="no-overlap-no-post-processing-1" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="no-overlap-no-post-processing-1"><span class="header-section-number">2.1</span> No overlap, no post-processing</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>spk_raw_res_path <span class="op">=</span> Path(<span class="st">'../results/spk_benchmark/r101_nobuf/'</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>truth_shps <span class="op">=</span> <span class="bu">sorted</span>([spk_raw_res_path<span class="op">/</span><span class="st">'vector_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(spk_raw_res_path<span class="op">/</span><span class="st">'vector_tiles'</span>)])</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>spk_raw_shps <span class="op">=</span> <span class="bu">sorted</span>([spk_raw_res_path<span class="op">/</span><span class="st">'raw_preds'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(spk_raw_res_path<span class="op">/</span><span class="st">'raw_preds'</span>)])</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>rasters <span class="op">=</span> <span class="bu">sorted</span>([spk_raw_res_path<span class="op">/</span><span class="st">'raster_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(spk_raw_res_path<span class="op">/</span><span class="st">'raster_tiles'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p, t <span class="kw">in</span> <span class="bu">zip</span>(spk_raw_shps, truth_shps):</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> gpd.read_file(p)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    temp_truth <span class="op">=</span> gpd.read_file(t)</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> gpd.clip(temp_pred, box(<span class="op">*</span>temp_truth.total_bounds))</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    temp_pred[<span class="st">'geometry'</span>] <span class="op">=</span> temp_pred.<span class="bu">apply</span>(<span class="kw">lambda</span> row: fix_multipolys(row.geometry) </span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>                                            <span class="cf">if</span> row.geometry.<span class="bu">type</span> <span class="op">==</span> <span class="st">'MultiPolygon'</span> </span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>                                            <span class="cf">else</span> shapely.geometry.Polygon(row.geometry.exterior), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    temp_pred[<span class="st">'label'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> temp_pred[temp_pred.geometry.area <span class="op">&gt;</span> <span class="dv">16</span><span class="op">*</span><span class="fl">0.0485</span><span class="op">**</span><span class="dv">2</span>]</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    temp_pred.to_file(spk_raw_res_path<span class="op">/</span><span class="st">'predicted_vectors'</span><span class="op">/</span>p.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>pred_shps <span class="op">=</span> <span class="bu">sorted</span>([spk_raw_res_path<span class="op">/</span><span class="st">'predicted_vectors'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(spk_raw_res_path<span class="op">/</span><span class="st">'predicted_vectors'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>truths <span class="op">=</span> <span class="va">None</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> <span class="va">None</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p, t <span class="kw">in</span> <span class="bu">zip</span>(pred_shps, truth_shps):</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> gpd.read_file(p)</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    temp_truth <span class="op">=</span> gpd.read_file(t)</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> truths <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>        truths <span class="op">=</span> temp_truth</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> temp_pred</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>        truths <span class="op">=</span> pd.concat((truths, temp_truth))</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> pd.concat((preds, temp_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>preds[<span class="st">'layer'</span>] <span class="op">=</span> preds.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="st">'groundwood'</span> <span class="cf">if</span> row.label <span class="op">==</span> <span class="dv">2</span> <span class="cf">else</span> <span class="st">'uprightwood'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>preds.shape, truths.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>((6893, 4), (5334, 4))</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>preds.layer.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>groundwood     5481
uprightwood    1412
Name: layer, dtype: int64</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>truths.rename(columns<span class="op">=</span>{<span class="st">'label'</span>:<span class="st">'layer'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>dis_truths <span class="op">=</span> truths.dissolve(by<span class="op">=</span><span class="st">'layer'</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>dis_preds <span class="op">=</span> preds.dissolve(by<span class="op">=</span><span class="st">'layer'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>IoU for standing deadwood is good already for this preprocessing level.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>poly_IoU(dis_truths, dis_preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>layer
groundwood     0.467202
uprightwood    0.605853
dtype: float64</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>deadwood_categories <span class="op">=</span> [{<span class="st">'supercategory'</span>: <span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">1</span>, <span class="st">'name'</span>:<span class="st">'uprightwood'</span>},</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>                       {<span class="st">'supercategory'</span>: <span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">2</span>, <span class="st">'name'</span>:<span class="st">'groundwood'</span>}]</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>spk_raw_coco_eval <span class="op">=</span> GisCOCOeval(spk_raw_res_path, spk_raw_res_path, </span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>                           <span class="va">None</span>, <span class="va">None</span>, deadwood_categories)</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>spk_raw_coco_eval.prepare_data(gt_label_col<span class="op">=</span><span class="st">'label'</span>)</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>spk_raw_coco_eval.prepare_eval()</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>spk_raw_coco_eval.coco_eval.params.maxDets <span class="op">=</span> [<span class="dv">1000</span>, <span class="dv">10000</span>]</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>spk_raw_coco_eval.evaluate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"7d3d9a4ed5e04c48a86ec57f2dd8b5cf","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"48c22653e640495096b8f9c60d038ff3","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>loading annotations into memory...
Done (t=0.19s)
creating index...
index created!
Loading and preparing results...
DONE (t=0.06s)
creating index...
index created!

Evaluating for category uprightwood
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=0.81s).
Accumulating evaluation results...
DONE (t=0.02s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=10000 ] = 0.249
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=10000 ] = 0.518
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=10000 ] = 0.224
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=10000 ] = 0.112
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=10000 ] = 0.326
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=10000 ] = 0.279
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.353
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.233
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.428
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 0.436

Evaluating for category groundwood
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=10.17s).
Accumulating evaluation results...
DONE (t=0.05s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=10000 ] = 0.129
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=10000 ] = 0.382
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=10000 ] = 0.049
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=10000 ] = 0.128
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=10000 ] = 0.174
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=10000 ] = -1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.233
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.234
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.215
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = -1.000

Evaluating for full data...
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=10.88s).
Accumulating evaluation results...
DONE (t=0.07s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=10000 ] = 0.189
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=10000 ] = 0.450
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=10000 ] = 0.136
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=10000 ] = 0.120
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=10000 ] = 0.250
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=10000 ] = 0.279
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.293
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.233
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.321
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 0.436</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>tp_truths <span class="op">=</span> truths.copy()</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>tp_truths[<span class="st">'label'</span>] <span class="op">=</span> tp_truths.layer.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="dv">1</span> <span class="cf">if</span> row<span class="op">==</span><span class="st">'uprightwood'</span> <span class="cf">else</span> <span class="dv">2</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>truth_sindex <span class="op">=</span> tp_truths.sindex</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>fp_preds <span class="op">=</span> preds.copy()</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>pred_sindex <span class="op">=</span> fp_preds.sindex</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>tp_truths[tp_cols] <span class="op">=</span> tp_truths.progress_apply(<span class="kw">lambda</span> row: is_true_positive(row, fp_preds, pred_sindex), </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>                                              axis<span class="op">=</span><span class="dv">1</span>, result_type<span class="op">=</span><span class="st">'expand'</span>)</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>fp_preds[fp_cols] <span class="op">=</span> fp_preds.progress_apply(<span class="kw">lambda</span> row: is_false_positive(row, tp_truths, truth_sindex,</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>                                                                            fp_preds, pred_sindex),</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>                                            axis<span class="op">=</span><span class="dv">1</span>, result_type<span class="op">=</span><span class="st">'expand'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(fp_preds.layer, fp_preds[<span class="st">'FP_0.5'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>FP_0.5</th>
      <th>FP</th>
      <th>TP</th>
      <th>All</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>3426</td>
      <td>2055</td>
      <td>5481</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>529</td>
      <td>883</td>
      <td>1412</td>
    </tr>
    <tr>
      <th>All</th>
      <td>3955</td>
      <td>2938</td>
      <td>6893</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(tp_truths.layer, tp_truths[<span class="st">'TP_0.5'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>TP_0.5</th>
      <th>FN</th>
      <th>TP</th>
      <th>All</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>1860</td>
      <td>2055</td>
      <td>3915</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>536</td>
      <td>883</td>
      <td>1419</td>
    </tr>
    <tr>
      <th>All</th>
      <td>2396</td>
      <td>2938</td>
      <td>5334</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p><span class="math inline">\(Precision = \frac{tp}{tp+fp}, Recall = \frac{tp}{tp+fn}\)</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Precision for fallen deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">2055</span><span class="op">/</span><span class="dv">5481</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Recall for fallen deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">2055</span><span class="op">/</span><span class="dv">3915</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Precision for fallen deadwood with IoU threshold of 0.5 is 0.37
Recall for fallen deadwood with IoU threshold of 0.5 is 0.52</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Precision for standing deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">883</span><span class="op">/</span><span class="dv">1412</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Recall for standing deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">883</span><span class="op">/</span><span class="dv">1419</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Precision for standing deadwood with IoU threshold of 0.5 is 0.63
Recall for standing deadwood with IoU threshold of 0.5 is 0.62</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Overall precision with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">2938</span><span class="op">/</span><span class="dv">6893</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Overall recall with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">2938</span><span class="op">/</span><span class="dv">5334</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Overall precision with IoU threshold of 0.5 is 0.43
Overall recall with IoU threshold of 0.5 is 0.55</code></pre>
</div>
</div>
</section>
<section id="half-patch-overlap-and-edge-filtering-1" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="half-patch-overlap-and-edge-filtering-1"><span class="header-section-number">2.2</span> Half patch overlap and edge filtering</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>spk_res_path <span class="op">=</span> Path(<span class="st">'../results/spk_benchmark/r101/'</span>)</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>truth_shps <span class="op">=</span> <span class="bu">sorted</span>([spk_res_path<span class="op">/</span><span class="st">'vector_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(spk_res_path<span class="op">/</span><span class="st">'vector_tiles'</span>)])</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>spk_buf_raw_shps <span class="op">=</span> <span class="bu">sorted</span>([spk_res_path<span class="op">/</span><span class="st">'raw_preds'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(spk_res_path<span class="op">/</span><span class="st">'raw_preds'</span>)])</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>rasters <span class="op">=</span> <span class="bu">sorted</span>([spk_res_path<span class="op">/</span><span class="st">'raster_tiles'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(spk_res_path<span class="op">/</span><span class="st">'raster_tiles'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p, t <span class="kw">in</span> <span class="bu">zip</span>(spk_buf_raw_shps, truth_shps):</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> gpd.read_file(p)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    temp_truth <span class="op">=</span> gpd.read_file(t)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> gpd.clip(temp_pred, box(<span class="op">*</span>temp_truth.total_bounds))</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    temp_pred[<span class="st">'geometry'</span>] <span class="op">=</span> temp_pred.<span class="bu">apply</span>(<span class="kw">lambda</span> row: fix_multipolys(row.geometry) </span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>                                            <span class="cf">if</span> row.geometry.<span class="bu">type</span> <span class="op">==</span> <span class="st">'MultiPolygon'</span> </span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>                                            <span class="cf">else</span> shapely.geometry.Polygon(row.geometry.exterior), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>    temp_pred[<span class="st">'label'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> temp_pred[temp_pred.geometry.area <span class="op">&gt;</span> <span class="dv">16</span><span class="op">*</span><span class="fl">0.0485</span><span class="op">**</span><span class="dv">2</span>]</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    temp_pred.to_file(spk_res_path<span class="op">/</span><span class="st">'predicted_vectors'</span><span class="op">/</span>p.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>pred_shps <span class="op">=</span> <span class="bu">sorted</span>([spk_res_path<span class="op">/</span><span class="st">'predicted_vectors'</span><span class="op">/</span>f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(spk_res_path<span class="op">/</span><span class="st">'predicted_vectors'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>truths <span class="op">=</span> <span class="va">None</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> <span class="va">None</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p, t <span class="kw">in</span> <span class="bu">zip</span>(pred_shps, truth_shps):</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    temp_pred <span class="op">=</span> gpd.read_file(p)</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>    temp_truth <span class="op">=</span> gpd.read_file(t)</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> truths <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>        truths <span class="op">=</span> temp_truth</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> temp_pred</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>        truths <span class="op">=</span> pd.concat((truths, temp_truth))</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> pd.concat((preds, temp_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>preds[<span class="st">'layer'</span>] <span class="op">=</span> preds.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="st">'groundwood'</span> <span class="cf">if</span> row.label <span class="op">==</span> <span class="dv">2</span> <span class="cf">else</span> <span class="st">'uprightwood'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>preds.shape, truths.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>((6511, 4), (5334, 4))</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>preds.layer.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>groundwood     5204
uprightwood    1307
Name: layer, dtype: int64</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>truths.rename(columns<span class="op">=</span>{<span class="st">'label'</span>:<span class="st">'layer'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>dis_truths <span class="op">=</span> truths.dissolve(by<span class="op">=</span><span class="st">'layer'</span>)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>dis_preds <span class="op">=</span> preds.dissolve(by<span class="op">=</span><span class="st">'layer'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>poly_IoU(dis_truths, dis_preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>layer
groundwood     0.469782
uprightwood    0.618346
dtype: float64</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>deadwood_categories <span class="op">=</span> [{<span class="st">'supercategory'</span>: <span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">1</span>, <span class="st">'name'</span>:<span class="st">'uprightwood'</span>},</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>                       {<span class="st">'supercategory'</span>: <span class="st">'deadwood'</span>, <span class="st">'id'</span>:<span class="dv">2</span>, <span class="st">'name'</span>:<span class="st">'groundwood'</span>}]</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>spk_coco_eval <span class="op">=</span> GisCOCOeval(spk_res_path, spk_res_path, </span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>                           <span class="va">None</span>, <span class="va">None</span>, deadwood_categories)</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>spk_coco_eval.prepare_data(gt_label_col<span class="op">=</span><span class="st">'label'</span>)</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>spk_coco_eval.prepare_eval()</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>spk_coco_eval.coco_eval.params.maxDets <span class="op">=</span> [<span class="dv">1000</span>, <span class="dv">10000</span>]</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>spk_coco_eval.evaluate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1bd584584d934aea93fc4ae56fde4643","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e3a76beaec7a4fa28a1c51dcb3d63184","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>loading annotations into memory...
Done (t=0.19s)
creating index...
index created!
Loading and preparing results...
DONE (t=0.05s)
creating index...
index created!

Evaluating for category uprightwood
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=0.73s).
Accumulating evaluation results...
DONE (t=0.02s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=10000 ] = 0.321
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=10000 ] = 0.591
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=10000 ] = 0.331
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=10000 ] = 0.145
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=10000 ] = 0.422
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=10000 ] = 0.362
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.398
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.237
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.495
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 0.657

Evaluating for category groundwood
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=9.72s).
Accumulating evaluation results...
DONE (t=0.05s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=10000 ] = 0.158
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=10000 ] = 0.438
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=10000 ] = 0.063
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=10000 ] = 0.155
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=10000 ] = 0.233
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=10000 ] = -1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.252
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.251
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.284
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = -1.000

Evaluating for full data...
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=10.63s).
Accumulating evaluation results...
DONE (t=0.07s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=10000 ] = 0.239
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=10000 ] = 0.514
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=10000 ] = 0.197
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=10000 ] = 0.150
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=10000 ] = 0.327
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=10000 ] = 0.362
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.325
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.244
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.390
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 0.657</code></pre>
</div>
</div>
<p>The overall AP50 score is close to the patch-level results here.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>tp_truths <span class="op">=</span> truths.copy()</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>tp_truths[<span class="st">'label'</span>] <span class="op">=</span> tp_truths.layer.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="dv">1</span> <span class="cf">if</span> row<span class="op">==</span><span class="st">'uprightwood'</span> <span class="cf">else</span> <span class="dv">2</span>)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>truth_sindex <span class="op">=</span> tp_truths.sindex</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>fp_preds <span class="op">=</span> preds.copy()</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>pred_sindex <span class="op">=</span> fp_preds.sindex</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>tp_truths[tp_cols] <span class="op">=</span> tp_truths.progress_apply(<span class="kw">lambda</span> row: is_true_positive(row, fp_preds, pred_sindex), </span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>                                              axis<span class="op">=</span><span class="dv">1</span>, result_type<span class="op">=</span><span class="st">'expand'</span>)</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>fp_preds[fp_cols] <span class="op">=</span> fp_preds.progress_apply(<span class="kw">lambda</span> row: is_false_positive(row, tp_truths, truth_sindex,</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>                                                                            fp_preds, pred_sindex),</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>                                            axis<span class="op">=</span><span class="dv">1</span>, result_type<span class="op">=</span><span class="st">'expand'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"618ea08d8540471a95737beb5330a560","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3bd08bb0ec0740c698589598b9042414","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(fp_preds.layer, fp_preds[<span class="st">'FP_0.5'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>FP_0.5</th>
      <th>FP</th>
      <th>TP</th>
      <th>All</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>3034</td>
      <td>2170</td>
      <td>5204</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>378</td>
      <td>929</td>
      <td>1307</td>
    </tr>
    <tr>
      <th>All</th>
      <td>3412</td>
      <td>3099</td>
      <td>6511</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(tp_truths.layer, tp_truths[<span class="st">'TP_0.5'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>TP_0.5</th>
      <th>FN</th>
      <th>TP</th>
      <th>All</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>1745</td>
      <td>2170</td>
      <td>3915</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>489</td>
      <td>930</td>
      <td>1419</td>
    </tr>
    <tr>
      <th>All</th>
      <td>2234</td>
      <td>3100</td>
      <td>5334</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p><span class="math inline">\(Precision = \frac{tp}{tp+fp}, Recall = \frac{tp}{tp+fn}\)</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Precision for fallen deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">2170</span><span class="op">/</span><span class="dv">5204</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Recall for fallen deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">2170</span><span class="op">/</span><span class="dv">3915</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Precision for fallen deadwood with IoU threshold of 0.5 is 0.42
Recall for fallen deadwood with IoU threshold of 0.5 is 0.55</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Precision for standing deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">929</span><span class="op">/</span><span class="dv">1307</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Recall for standing deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">930</span><span class="op">/</span><span class="dv">1419</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Precision for standing deadwood with IoU threshold of 0.5 is 0.71
Recall for standing deadwood with IoU threshold of 0.5 is 0.66</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Overall precision with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">3099</span><span class="op">/</span><span class="dv">6511</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Overall recall with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">3100</span><span class="op">/</span><span class="dv">5334</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Overall precision with IoU threshold of 0.5 is 0.48
Overall recall with IoU threshold of 0.5 is 0.58</code></pre>
</div>
</div>
</section>
<section id="overlap-edge-filtering-and-mask-merging-1" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="overlap-edge-filtering-and-mask-merging-1"><span class="header-section-number">2.3</span> Overlap, edge filtering and mask merging</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>merge_outpath <span class="op">=</span> Path(<span class="st">'../results/spk_benchmark/r101_merge/'</span>)</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(merge_outpath):</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    shutil.copytree(<span class="st">'../results/spk_template/'</span>, merge_outpath, symlinks<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Two iterations of merging is usually enough.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> pred_shps:</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>    gdf_temp <span class="op">=</span> gpd.read_file(r)</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    standing <span class="op">=</span> gdf_temp[gdf_temp.label<span class="op">==</span><span class="dv">1</span>].copy()</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    fallen <span class="op">=</span> gdf_temp[gdf_temp.label<span class="op">==</span><span class="dv">2</span>].copy()</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(standing) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>        standing <span class="op">=</span> merge_polys(standing, <span class="fl">0.2</span>)</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>        standing <span class="op">=</span> merge_polys(standing, <span class="fl">0.2</span>)</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(fallen) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>        fallen <span class="op">=</span> merge_polys(fallen, <span class="fl">0.2</span>)</span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>        fallen <span class="op">=</span> merge_polys(fallen, <span class="fl">0.2</span>)</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>    gdf_merged <span class="op">=</span> pd.concat((standing, fallen))</span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>    gdf_merged.to_file(merge_outpath<span class="op">/</span><span class="st">'predicted_vectors'</span><span class="op">/</span>r.name, driver<span class="op">=</span><span class="st">'GeoJSON'</span>)</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>    gdf_merged <span class="op">=</span> <span class="va">None</span></span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a>    gdf_temp <span class="op">=</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>merged_coco_eval <span class="op">=</span> GisCOCOeval(merge_outpath, merge_outpath, <span class="va">None</span>, <span class="va">None</span>, deadwood_categories)</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>merged_coco_eval.prepare_data(gt_label_col<span class="op">=</span><span class="st">'label'</span>)</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>merged_coco_eval.prepare_eval()</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>merged_coco_eval.evaluate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e4f2ff85c3df435294e062e14ffc2315","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3430858b58d14e2fba675a7d124c93d0","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>loading annotations into memory...
Done (t=0.20s)
creating index...
index created!
Loading and preparing results...
DONE (t=0.31s)
creating index...
index created!

Evaluating for category uprightwood
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=0.68s).
Accumulating evaluation results...
DONE (t=0.02s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.311
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=1000 ] = 0.572
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=1000 ] = 0.321
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.142
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.408
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 0.420
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.378
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.228
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.469
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.636

Evaluating for category groundwood
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=7.82s).
Accumulating evaluation results...
DONE (t=0.04s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.160
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=1000 ] = 0.450
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=1000 ] = 0.064
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.157
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.258
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = -1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.205
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.203
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.275
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = -1.000

Evaluating for full data...
Running per image evaluation...
Evaluate annotation type *segm*
DONE (t=8.47s).
Accumulating evaluation results...
DONE (t=0.06s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=1000 ] = 0.236
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=1000 ] = 0.511
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=1000 ] = 0.192
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=1000 ] = 0.149
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=1000 ] = 0.333
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=1000 ] = 0.420
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.292
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.215
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.372
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.636</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>preds.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>standing <span class="op">=</span> merge_polys(preds[preds.label <span class="op">==</span> <span class="dv">1</span>].copy(), <span class="fl">0.2</span>)</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>fallen <span class="op">=</span> merge_polys(preds[preds.label <span class="op">==</span> <span class="dv">2</span>].copy(), <span class="fl">0.2</span>)</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>standing <span class="op">=</span> merge_polys(standing, <span class="fl">0.2</span>)</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>fallen <span class="op">=</span> merge_polys(fallen, <span class="fl">0.2</span>)</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>preds_merged <span class="op">=</span> pd.concat((standing, fallen))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>preds_merged[<span class="st">'layer'</span>] <span class="op">=</span> preds_merged.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="st">'groundwood'</span> <span class="cf">if</span> row.label <span class="op">==</span> <span class="dv">2</span> <span class="cf">else</span> <span class="st">'uprightwood'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>preds_merged.layer.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>groundwood     4130
uprightwood    1190
Name: layer, dtype: int64</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>tp_truths <span class="op">=</span> truths.copy()</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>tp_truths[<span class="st">'label'</span>] <span class="op">=</span> tp_truths.layer.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="dv">1</span> <span class="cf">if</span> row<span class="op">==</span><span class="st">'uprightwood'</span> <span class="cf">else</span> <span class="dv">2</span>)</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>truth_sindex <span class="op">=</span> tp_truths.sindex</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>fp_preds_merged <span class="op">=</span> preds_merged.copy()</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>pred_sindex <span class="op">=</span> fp_preds_merged.sindex</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>tp_truths[tp_cols] <span class="op">=</span> tp_truths.progress_apply(<span class="kw">lambda</span> row: is_true_positive(row, fp_preds_merged, pred_sindex), </span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>                                              axis<span class="op">=</span><span class="dv">1</span>, result_type<span class="op">=</span><span class="st">'expand'</span>)</span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>fp_preds_merged[fp_cols] <span class="op">=</span> fp_preds_merged.progress_apply(<span class="kw">lambda</span> row: is_false_positive(row, tp_truths, truth_sindex,</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>                                                                            fp_preds_merged, pred_sindex),</span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>                                            axis<span class="op">=</span><span class="dv">1</span>, result_type<span class="op">=</span><span class="st">'expand'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3a1d4bc5003b4dba85ab2111b7c27666","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c8306eec529c4f9aa461a9b219493c4b","version_major":2,"version_minor":0}
</script>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(fp_preds_merged.layer, fp_preds_merged[<span class="st">'FP_0.5'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>FP_0.5</th>
      <th>FP</th>
      <th>TP</th>
      <th>All</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>2014</td>
      <td>2116</td>
      <td>4130</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>306</td>
      <td>884</td>
      <td>1190</td>
    </tr>
    <tr>
      <th>All</th>
      <td>2320</td>
      <td>3000</td>
      <td>5320</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(tp_truths.layer, tp_truths[<span class="st">'TP_0.5'</span>], margins<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>TP_0.5</th>
      <th>FN</th>
      <th>TP</th>
      <th>All</th>
    </tr>
    <tr>
      <th>layer</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>groundwood</th>
      <td>1800</td>
      <td>2115</td>
      <td>3915</td>
    </tr>
    <tr>
      <th>uprightwood</th>
      <td>534</td>
      <td>885</td>
      <td>1419</td>
    </tr>
    <tr>
      <th>All</th>
      <td>2334</td>
      <td>3000</td>
      <td>5334</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p><span class="math inline">\(Precision = \frac{tp}{tp+fp}, Recall = \frac{tp}{tp+fn}\)</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Precision for fallen deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">2116</span><span class="op">/</span><span class="dv">4130</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Recall for fallen deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">2115</span><span class="op">/</span><span class="dv">3915</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Precision for fallen deadwood with IoU threshold of 0.5 is 0.51
Recall for fallen deadwood with IoU threshold of 0.5 is 0.54</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Precision for standing deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">884</span><span class="op">/</span><span class="dv">1190</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Recall for standing deadwood with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">885</span><span class="op">/</span><span class="dv">1419</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Precision for standing deadwood with IoU threshold of 0.5 is 0.74
Recall for standing deadwood with IoU threshold of 0.5 is 0.62</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Overall precision with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">3000</span><span class="op">/</span><span class="dv">5320</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Overall recall with IoU threshold of 0.5 is </span><span class="sc">{</span>(<span class="dv">3000</span><span class="op">/</span><span class="dv">5334</span>)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Overall precision with IoU threshold of 0.5 is 0.56
Overall recall with IoU threshold of 0.5 is 0.56</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="./4_patch_level_results.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Patch level results</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./6_result_comparison_with_field_data.html" class="pagination-link">
        <span class="nav-page-text">Result comparison with field data</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>